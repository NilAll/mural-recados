<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Admin - Gest√£o</title>
    
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>try{emailjs.init("vOaHzeApkyntx09x6");}catch(e){}</script>
    
    <style>
        /* ESTILOS BASE */
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; -webkit-user-select: none; user-select: none; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        body { padding: 20px; background: #f0f2f5; max-width: 900px; margin: 0 auto; color: #333; padding-bottom: 80px; }

        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #1a1a1a; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { text-align: center; background: #2c2c2c; padding: 40px; border-radius: 16px; width: 90%; max-width: 380px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        .login-input { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #444; background: #333; color: white; font-size: 16px; }
        .btn-login { background: #007bff; color: white; padding: 12px; width: 100%; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }

        .header-admin { display: none; justify-content: space-between; align-items: center; margin-bottom: 25px; background: white; padding: 15px 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .badge-role { background: #ffc107; color: #333; padding: 3px 8px; border-radius: 6px; font-size: 11px; font-weight: 800; text-transform: uppercase; margin-left: 10px; }
        
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; display: none; box-shadow: 0 4px 12px rgba(0,0,0,0.05); position: relative; overflow: hidden; border-top: 4px solid #ccc; }
        .card h2 { margin-top: 0; margin-bottom: 20px; font-size: 18px; color: #444; border-bottom: 1px solid #eee; padding-bottom: 12px; }
        
        #painelCidades { border-color: #ff5722; } #painelAdminsLocais { border-color: #343a40; } #painelPalpites { border-color: #9c27b0; } #painelUsuarios { border-color: #28a745; } #painelVips { border-color: #ffc107; } #painelCategorias { border-color: #17a2b8; } #painelCadastro { border-color: #007bff; } #painelLista { border-color: #6c757d; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px; }
        .form-full { width: 100%; margin-bottom: 15px; }
        label { font-weight: 600; font-size: 13px; color: #666; margin-bottom: 6px; display: block; }
        input, select, textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; background: #fff; }
        
        .btn { border: none; padding: 10px 15px; border-radius: 8px; font-weight: 600; cursor: pointer; color: white; font-size: 13px; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: #007bff; } .btn-success { background: #28a745; } .btn-danger { background: #dc3545; } .btn-warning { background: #ffc107; color: #333; } .btn-info { background: #17a2b8; } .btn-dark { background: #343a40; }
        .btn-sm { padding: 5px 10px; font-size: 11px; border-radius: 6px; }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }

        .manager-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 12px 15px; border: 1px solid #eee; margin-bottom: 8px; border-radius: 8px; }
        .cat-block { border: 1px solid #e0e0e0; border-radius: 8px; margin-bottom: 15px; overflow: hidden; background: white; }
        .cat-header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: #fff; cursor: pointer; }
        .cat-actions { display: flex; gap: 5px; }
        .sub-manager-container { display: none; background: #f4f6f8; padding: 10px; border-top: 1px solid #e0e0e0; }
        .sub-item { display: flex; justify-content: space-between; align-items: center; background: white; padding: 8px 12px; border-radius: 6px; border: 1px solid #ddd; margin-bottom: 5px; font-size: 13px; }
        .sector-manager-container { display: none; margin-top: 5px; padding-left: 10px; border-left: 2px solid #ccc; width: 100%; }
        .sector-item { font-size: 12px; color: #555; padding: 3px 0; display: flex; justify-content: space-between; }
        .input-inline { width: 70%; padding: 6px; border: 1px solid #ccc; border-radius: 4px; font-size: 12px; }
        .input-sub-add { width: 70% !important; display: inline-block; margin: 0; }

        .checkbox-group { display: flex; flex-wrap: wrap; gap: 15px; background: #f8f9fa; padding: 15px; border-radius: 8px; border: 1px solid #eee; align-items: center; }
        .menu-adder { display: flex; gap: 10px; align-items: center; background: #fff; padding: 10px; border: 1px solid #ddd; border-radius: 8px; }
        .menu-row { display: flex; justify-content: space-between; padding: 8px; border-bottom: 1px solid #f0f0f0; align-items: center; font-size: 13px; }
        .thumb-menu { width: 40px; height: 40px; object-fit: cover; border-radius: 4px; vertical-align: middle; margin-right: 10px; background: #eee; }

        .modal-icons { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: none; align-items: center; justify-content: center; }
        .modal-icons-content { background: white; width: 90%; max-width: 400px; padding: 25px; border-radius: 12px; text-align: center; }
        #inputCustomIcon { font-size: 40px; text-align: center; padding: 10px; width: 100%; margin-bottom: 20px; }
        
        /* Badges de Status na Lista */
        .badge-status { font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: bold; margin-left: 5px; }
        .badge-delivery { background:#e8f5e9; color:#2e7d32; border:1px solid #c8e6c9; }
        
        .palpite-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
        .palpite-num { font-size: 20px; font-weight: bold; background: #9c27b0; color: white; padding: 5px 12px; border-radius: 50%; }
        .palpite-info { flex: 1; margin-left: 15px; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <img src="logo.png" style="max-width:120px; margin-bottom:20px; cursor: pointer;" alt="Logo" onclick="window.location.href='index.html'">
            <h3 style="color:white; margin-bottom:20px;">Acesso Administrativo</h3>
            <input id="inputUsuario" class="login-input" placeholder="Usu√°rio">
            <input id="inputSenha" type="password" class="login-input" placeholder="Senha" onkeypress="if(event.key==='Enter') fazerLogin()">
            <button class="btn btn-primary" style="margin-top:20px; width:100%;" onclick="fazerLogin()">Entrar</button>
        </div>
    </div>

    <div class="header-admin" id="headerAdmin">
        <div class="header-left">
            <h2 style="margin:0; font-size:20px;">Painel de Gest√£o <span id="roleBadge" class="badge-role">...</span></h2>
        </div>
        <a href="index.html" class="btn btn-secondary btn-sm">üè† Ver App</a>
    </div>

    <div class="card" id="painelCidades">
        <h2>üèôÔ∏è Cidades (Estrutura)</h2>
        <div id="listaCidades" style="margin-bottom:20px;">Carregando...</div>
        <div style="background:#f8f9fa; padding:15px; border-radius:8px;">
            <h3 style="font-size:15px; margin-top:0;">Cadastrar Nova Cidade</h3>
            <div class="form-grid"><div><label>Nome</label><input id="novaCidadeNome" placeholder="Ex: S√£o Paulo"></div><div><label>UF</label><input id="novaCidadeUF" placeholder="SP"></div></div>
            <div class="form-grid"><div><label>Link Fundo</label><input id="novaCidadeFundo"></div><div><label>Link Logo</label><input id="novaCidadeLogo"></div></div>
            <div class="form-grid"><div><label>Definir Login Admin</label><input id="novaCidadeLogin"></div><div><label>Definir Senha Admin</label><input id="novaCidadeSenha"></div></div>
            <button class="btn btn-success" style="width:100%;" onclick="salvarCidade()">+ Adicionar Cidade</button>
        </div>
    </div>

    <div class="card" id="painelAdminsLocais">
        <h2>üëÆ Gest√£o de Admins Locais</h2>
        <div id="listaAdminsLocais">Carregando...</div>
    </div>
    
    <div class="card" id="painelPalpites">
        <h2>üé≤ Palpites dos VIPs (Sua Cidade)</h2>
        <p style="color:#666; font-size:13px; margin-bottom:15px;">Estes s√£o os n√∫meros da sorte gerados pelos VIPs da sua cidade.</p>
        <button class="btn btn-danger btn-sm" style="margin-bottom:15px;" onclick="limparPalpites()">üóëÔ∏è Limpar Lista</button>
        <div id="listaPalpites" style="background:#fff; border:1px solid #ddd; border-radius:8px; max-height:400px; overflow-y:auto;">
            <div style="padding:20px; text-align:center;">Carregando palpites...</div>
        </div>
    </div>

    <div class="card" id="painelUsuarios"><h2>üë• Usu√°rios do App</h2><div id="listaUsuarios"></div><div id="formEditUser" style="display:none; background:#e3f2fd; padding:15px; border-radius:8px; margin-top:20px; border:1px solid #90caf9;"><h3 style="margin-top:0; font-size:16px; color:#0d47a1;">‚úèÔ∏è Editando Usu√°rio</h3><div class="form-grid"><div><label>Nome</label><input type="text" id="editUserName"></div><div><label>E-mail (Fixo)</label><input type="text" id="editUserEmail" disabled style="background:#ddd;"></div></div><div class="form-grid"><div><label>Nova Senha</label><input type="text" id="editUserPass"></div><div><label>Cidade</label><select id="editUserCidade"><option value="">Selecione...</option></select></div></div><div class="btn-row"><button class="btn btn-success" onclick="salvarEdicaoUsuario()">Salvar Altera√ß√µes</button><button class="btn btn-danger" onclick="cancelarEdicaoUsuario()">Cancelar</button></div></div></div>
    
    <div class="card" id="painelVips">
        <h2>üíé Membros VIP</h2>
        <div class="form-grid"><div><label>Nome Completo</label><input id="vipNome"></div><div><label>Nascimento</label><input type="date" id="vipNasc"></div></div>
        <div class="form-grid">
            <div><label>WhatsApp (Com DDD)</label><input type="number" id="vipPhone" placeholder="5511999999999"></div>
            <div><label>E-mail</label><input type="email" id="vipEmail"></div>
        </div>
        <div class="form-full"><label>Palavra Secreta (Senha)</label><input type="text" id="vipPalavra"></div>
        <div class="btn-row"><button id="btnSalvarVip" class="btn btn-success" style="width:100%;" onclick="salvarVip()">Cadastrar VIP</button><button id="btnCancelVip" class="btn btn-danger" style="display:none;" onclick="cancelarEdicaoVip()">Cancelar</button></div>
        <hr style="margin:20px 0; border:0; border-top:1px solid #eee;"><div id="listaVips"></div>
    </div>

    <div class="card" id="painelCategorias"><h2>üìÇ Categorias e √çcones</h2><div id="listaGestaoCategorias"></div><div style="margin-top:20px; display:flex; gap:10px;"><input id="novaCategoriaInput" placeholder="Nome da Nova Categoria" style="flex:1;"><button class="btn btn-success" onclick="adicionarCategoria()">+ Criar</button></div></div>
    
    <div class="card" id="painelMasterConfig">
        <h2>‚öôÔ∏è Configura√ß√µes Gerais</h2>
        <div class="form-grid"><div><label>Nome App</label><input type="text" id="confNomeCidade"></div><div><label>WhatsApp Admin</label><input type="number" id="confZapAdmin"></div></div>
        <div style="background:#f9f9f9; padding:15px; border-radius:8px; margin-bottom:15px;">
            <label>üé® Cores (0-100)</label>
            <div class="form-grid"><div><label>Azul</label><input type="range" id="opacAzul"></div><div><label>Preto</label><input type="range" id="opacPreto"></div></div>
        </div>
        <div class="form-grid">
            <div style="background:#e8f5e9; padding:15px; border-radius:8px; border:1px solid #c8e6c9;">
                <label style="color:#2e7d32; border-bottom:1px solid #a5d6a7; margin-bottom:10px;">üìå Logo do Topo</label>
                <label>Tamanho (px):</label><input id="confHeaderSize" type="number" placeholder="Ex: 50">
                <label>Dist√¢ncia Topo (px):</label><input id="confHeaderTop" type="number" placeholder="Ex: 10">
            </div>
            <div style="background:#fff3e0; padding:15px; border-radius:8px; border:1px solid #ffe0b2;">
                <label style="color:#ef6c00; border-bottom:1px solid #ffcc80; margin-bottom:10px;">ü§ù Logo Rodap√©</label>
                <label>Tamanho (px):</label><input id="confSponsorSize" type="number" placeholder="Ex: 60">
                <label>Dist√¢ncia Rodap√© (px):</label><input id="confSponsorBottom" type="number" placeholder="Ex: 15">
            </div>
        </div>
        <button class="btn btn-primary" style="width:100%;" onclick="salvarConfigGlobal()">Salvar Configura√ß√µes</button>
    </div>

    <div class="card" id="painelCadastro" style="display:block;">
        <h2 id="tituloForm">üè™ Cadastrar / Editar Local</h2>
        <div class="form-grid" style="background:#eef; padding:15px; border-radius:8px; margin-bottom:20px;"><div><label style="color:#ff5722;">1. Cidade</label><select id="selCidadeCadastro" style="border:1px solid #ff5722"></select></div><div><label style="color:#007bff;">2. Categoria</label><select id="categoria" style="border:1px solid #007bff;"><option value="">Selecione...</option></select></div><div><label>3. Subcategoria</label><select id="subcategoria" disabled><option value="">...</option></select></div><div><label>4. Setor</label><select id="setor" disabled><option value="">...</option></select></div></div>
        
        <div class="form-full"><label>Nome do Estabelecimento</label><input id="nome"></div>
        
        <div class="form-full">
            <label>Descri√ß√£o (Slogan/Resumo)</label>
            <input id="descricao" maxlength="60" placeholder="Ex: O melhor hotdog da regi√£o (M√°x 60 letras)">
        </div>

        <div class="form-grid"><div><label>R$ Riscado</label><input id="precoAntigo" placeholder="0,00"></div><div><label>R$ Atual</label><input id="precoAtual" placeholder="0,00"></div></div>
        <div class="form-full"><label>Endere√ßo Completo</label><input id="cidade"></div>
        <div class="form-grid"><div><label>Link Google Maps</label><input id="linkMapa"></div><div><label>Link Imagem (Capa)</label><input id="imagem"></div></div>
        <div class="form-grid"><div><label>WhatsApp</label><input id="contato"></div><div><label>Instagram</label><input id="instagram"></div><div><label>Telefone Fixo</label><input id="telFixo"></div></div>
        
        <div class="checkbox-group">
            <label style="display:flex; align-items:center; gap:5px; color:#28a745; font-weight:bold;"><input type="checkbox" id="checkDelivery" onclick="verificarTermosDelivery(this)"> üõµ Ativar Delivery</label>
            <label style="display:flex; align-items:center; gap:5px;"><input type="checkbox" id="checkPubli"> üì¢ Banner</label>
            <label style="display:flex; align-items:center; gap:5px; color:#ffc107; font-weight:bold;"><input type="checkbox" id="checkPartner"> ‚≠ê Parceiro</label>
        </div>
        <div id="boxInfoDelivery" style="display:none; margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
            <h4 style="margin:0 0 10px 0;">üìù Criar Card√°pio (Obrigat√≥rio para Sorteio)</h4>
            <div class="menu-adder"><div style="flex:2;"><input id="prodNome" placeholder="Nome"></div><div style="flex:1;"><input id="prodPreco" placeholder="Pre√ßo"></div><div style="flex:2;"><input id="prodImg" placeholder="Link Foto"></div><button class="btn btn-info btn-sm" onclick="addItemMenu()">+ Add</button></div>
            <div id="lista-cardapio-preview" style="margin-top:10px; border:1px solid #eee; padding:10px; border-radius:8px;"></div>
            <div style="margin-top:20px; background:#e8f5e9; padding:10px; border-radius:8px;"><label style="color:#28a745;">üéÅ Selecione o Brinde VIP (Do Menu)</label><select id="deliveryBrinde" style="border:1px solid #28a745; background:white;"><option value="">Primeiro adicione itens ao menu...</option></select><p style="font-size:12px; color:#666; margin:5px 0 0 0;">*Este item ser√° listado para o VIP escolher.</p></div>
        </div>
        <div id="boxPubli" style="display:none; margin-top:15px;"><label>Imagem do Banner</label><input id="imgPubli"></div>
        <div class="btn-row"><button id="btnSalvar" class="btn btn-save btn-success" onclick="salvarOuAtualizar()">Salvar Registro</button><button id="btnCancelar" class="btn btn-danger" style="display:none;" onclick="limparForm()">Cancelar</button></div>
    </div>

    <div class="card" id="painelLista" style="display:block;"><h3>üìã Lista de Cadastros</h3><div id="lista-locais"></div></div>

    <div id="modalTermos" class="modal-icons"><div class="modal-icons-content"><h3 style="color:#28a745;">üìú Termos do Delivery</h3><p style="text-align:left; line-height:1.6; color:#555;">1. Pagar taxa de manuten√ß√£o.<br>2. Doar <b>1 Brinde</b> a cada ciclo (aprox. 4 meses).</p><div class="btn-row" style="justify-content:center;"><button class="btn btn-success" onclick="aceitarTermos()">Concordo</button><button class="btn btn-danger" onclick="recusarTermos()">Cancelar</button></div></div></div>
    <div id="modalIconPicker" class="modal-icons"><div class="modal-icons-content"><h3>√çcone</h3><input type="text" id="inputCustomIcon" placeholder="üçï"><div class="btn-row" style="justify-content:center;"><button class="btn btn-success" onclick="salvarIconeCustomizado()">Salvar</button><button class="btn btn-danger" onclick="closeIconPicker()">Cancelar</button></div></div></div>

    <script type="module">
        const VERSAO_ATUAL="5.0"; 
        if(localStorage.getItem("v_adm")!==VERSAO_ATUAL){localStorage.setItem("v_adm",VERSAO_ATUAL);location.reload(true);}
        
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, where, getDocs, orderBy, limit, writeBatch } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const app=initializeApp({apiKey:"AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw",authDomain:"testegithub-e1ffb.firebaseapp.com",projectId:"testegithub-e1ffb",storageBucket:"testegithub-e1ffb.firebasestorage.app",messagingSenderId:"508103458559",appId:"1:508103458559:web:55bc2fe4dc61d7b5ee16ca"}); 
        const db=getFirestore(app); const el=id=>document.getElementById(id);
        let currentUser=null, listaSubs={}, listaSetores={}, customIcons={}, idEditando=null, catEditing=null, idVipEditando=null, idUsuarioEditando=null, cardapio=[];

        window.fazerLogin=async()=>{const u=el('inputUsuario').value.trim(),p=el('inputSenha').value; if(!u||!p) return alert("Preencha tudo"); if(u==='master'&&p==='master123'){currentUser={role:'master'};init();return;} try{let q=query(collection(db,"cidades"),where("login","==",u),where("senha","==",p));let s=await getDocs(q);if(!s.empty){currentUser={role:'city',cityId:s.docs[0].id};init();return;} alert("Dados incorretos");}catch(e){alert("Erro conex√£o");}};
        function init(){
            el('loginScreen').style.display='none';el('headerAdmin').style.display='flex'; const m=currentUser.role==='master'; const c=currentUser.role==='city';
            el('painelCidades').style.display=m?'block':'none';
            el('painelAdminsLocais').style.display=m?'block':'none';
            el('painelUsuarios').style.display=m?'block':'none';
            el('painelMasterConfig').style.display=m?'block':'none';
            el('painelPalpites').style.display=c?'block':'none';
            el('painelVips').style.display=c?'block':'none'; 
            el('painelCategorias').style.display='block';
            el('painelCadastro').style.display='block';
            el('painelLista').style.display='block'; 
            loadData(); if(c) carregarPalpites();
        }
        
        async function loadData(){
            onSnapshot(collection(db,"cidades"),s=>{el('selCidadeCadastro').innerHTML='<option value="">Selecione a Cidade</option>'; el('listaCidades').innerHTML=""; el('listaAdminsLocais').innerHTML=""; s.forEach(d=>{el('selCidadeCadastro').innerHTML+=`<option value="${d.id}">${d.data().nome}</option>`; 
                if(currentUser.role==='master') {
                    el('listaCidades').innerHTML+=`<div class="manager-item"><b>${d.data().nome}</b></div>`;
                    el('listaAdminsLocais').innerHTML+=`<div class="manager-item"><div><b>${d.data().nome}</b><br><small>User: ${d.data().login} | Senha: ${d.data().senha}</small></div><button class="btn btn-warning btn-sm" onclick="alert('Edite no painel de Cidades')">Ver</button></div>`;
                }
            });});
            onSnapshot(doc(db,"config","categorias"),s=>{listaSubs=s.exists()?s.data():{"_order":[]};renderCats();});
            onSnapshot(doc(db,"config","setores"),s=>{listaSetores=s.exists()?s.data():{};});
            onSnapshot(doc(db,"config","icons"),s=>{customIcons=s.exists()?s.data():{};renderCats();});
            onSnapshot(doc(db,"config","geral"),s=>{if(s.exists()){const d=s.data();el('confZapAdmin').value=d.zapAdmin||"";el('confNomeCidade').value=d.titulo||"";el('opacAzul').value=d.opacAzul||80;el('opacPreto').value=d.opacPreto||50;el('confHeaderSize').value=d.headerSize||"";el('confHeaderTop').value=d.headerTop||"";el('confSponsorSize').value=d.sponsorSize||"";el('confSponsorBottom').value=d.sponsorBottom||"";}});
            onSnapshot(collection(db,"vips"),s=>{el('listaVips').innerHTML="";s.forEach(d=>el('listaVips').innerHTML+=`<div class="manager-item"><div><b>${d.data().nome}</b> (${d.data().palavra})<br><small>${d.data().whatsapp||'-'}</small></div><div><button class="btn btn-warning btn-sm" onclick="editVip('${d.id}','${d.data().nome}','${d.data().nasc}','${d.data().email}','${d.data().palavra}','${d.data().whatsapp}')">‚úèÔ∏è</button><button class="btn btn-danger btn-sm" onclick="delVip('${d.id}')">X</button></div></div>`);});
            
            let q=query(collection(db,"guia_cidades")); if(currentUser.role==='city') q=query(collection(db,"guia_cidades"),where("cidadeId","==",currentUser.cityId));
            onSnapshot(q,s=>{
                el('lista-locais').innerHTML="";
                s.forEach(d=>{
                    const item=d.data();
                    let badges="";
                    if(item.temDelivery) badges+=`<span class="badge-status badge-delivery">üõµ Delivery</span>`;
                    let path = item.categoria || "";
                    if(item.subcategoria) path += " > " + item.subcategoria;
                    if(item.setor) path += " > " + item.setor;

                    el('lista-locais').innerHTML+=`
                    <div class="manager-item">
                        <div>
                            <b>${item.nome}</b> ${badges}<br>
                            <small style="color:#666;">${path}</small>
                        </div>
                        <div>
                            <button class="btn btn-warning btn-sm" onclick="editLocal('${d.id}','${encodeURIComponent(JSON.stringify(item))}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-sm" onclick="delLocal('${d.id}')">X</button>
                        </div>
                    </div>`;
                });
            });
            if(currentUser.role==='master'){onSnapshot(collection(db,"users"),(snap)=>{el('listaUsuarios').innerHTML="";snap.forEach(doc=>{const u=doc.data();el('listaUsuarios').innerHTML+=`<div class="manager-item"><div><b>${u.nome}</b> (${u.email})</div><div><button class="btn btn-warning btn-sm" onclick="prepararEdicaoUsuario('${doc.id}','${u.nome}','${u.email}','${u.senha}','${u.cidadeId||''}')">‚úèÔ∏è</button></div></div>`;});});}
        }

        // FUN√á√ïES RESTANTES (MANTIDAS)
        function carregarPalpites() {
            if(!currentUser.cityId) return;
            const q = query(collection(db, "vip_palpites"), where("cidadeId", "==", currentUser.cityId));
            onSnapshot(q, (snap) => {
                const div = el('listaPalpites'); div.innerHTML = "";
                if(snap.empty) { div.innerHTML = "<div style='padding:20px; text-align:center;'>Nenhum palpite nesta cidade.</div>"; return; }
                let palpites = [];
                snap.forEach(doc => palpites.push(doc.data()));
                palpites.sort((a,b) => (b.data?.seconds || 0) - (a.data?.seconds || 0));
                palpites.forEach(d => {
                    const data = d.data ? new Date(d.data.seconds * 1000).toLocaleString() : '-';
                    let btnZap = "";
                    if(d.vipZap) {
                        const msg = encodeURIComponent(`Ol√° ${d.vipNome}! Parab√©ns! Voc√™ foi o ganhador do sorteio: ${d.brinde} (${d.loja}). Seu n√∫mero da sorte foi ${d.numero}.`);
                        btnZap = `<a href="https://wa.me/${d.vipZap}?text=${msg}" target="_blank" class="btn btn-success btn-sm" style="text-decoration:none; margin-left:10px;">üì± Avise o Ganhador</a>`;
                    }
                    div.innerHTML += `<div class="palpite-row"><div style="display:flex; align-items:center;"><div class="palpite-num">${d.numero}</div><div class="palpite-info"><div style="font-weight:bold; font-size:14px;">${d.vipNome}</div><div style="font-size:12px; color:#555;">Quer: <b>${d.brinde}</b></div><div style="font-size:10px; color:#999;">${data}</div></div></div>${btnZap}</div>`;
                });
            });
        }
        window.limparPalpites = async () => { if(!confirm("Apagar todos?")) return; const q = query(collection(db, "vip_palpites"), where("cidadeId", "==", currentUser.cityId)); const snap = await getDocs(q); const batch = writeBatch(db); snap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); alert("Limpo!"); };
        window.addItemMenu = () => {const nome = el('prodNome').value; const preco = el('prodPreco').value; const img = el('prodImg').value;if(!nome || !preco) return alert("Preencha Nome e Pre√ßo");cardapio.push({nome, preco, img}); el('prodNome').value=""; el('prodPreco').value=""; el('prodImg').value="";renderMenu(); atualizarSelectBrindes();};
        function renderMenu() {el('lista-cardapio-preview').innerHTML = cardapio.map((x,i)=>`<div class="menu-row"><div style="display:flex; align-items:center;">${x.img ? `<img src="${x.img}" class="thumb-menu">` : ''}<span>${x.nome} - R$ ${x.preco}</span></div><button class="btn btn-danger btn-sm" onclick="window.removeMenu(${i})">X</button></div>`).join('');}
        window.removeMenu = (i) => { cardapio.splice(i,1); renderMenu(); atualizarSelectBrindes(); };
        function atualizarSelectBrindes() {const sel = el('deliveryBrinde'); const atual = sel.value;sel.innerHTML = '<option value="">Selecione do Menu...</option>';cardapio.forEach(item => { sel.innerHTML += `<option value="${item.nome}">${item.nome}</option>`; });sel.value = atual;}
        
        // SALVAR (COM DESCRI√á√ÉO)
        window.salvarOuAtualizar=async()=>{
            const temDelivery = el('checkDelivery').checked;
            const d={
                cidadeId:el('selCidadeCadastro').value, nome:el('nome').value, nomeBusca:el('nome').value.toLowerCase(),
                // NOVO CAMPO SALVO
                descricao: el('descricao').value,
                
                categoria:el('categoria').value, subcategoria:el('subcategoria').value, setor:el('setor').value,
                contato:el('contato').value, instagram:el('instagram').value, imagem:el('imagem').value,
                preco:parseFloat(el('precoAtual').value)||0, precoAntigo:parseFloat(el('precoAntigo').value)||0,
                isPartner:el('checkPartner').checked, temDelivery: temDelivery,
                deliveryBrinde:el('deliveryBrinde').value,cardapio: cardapio,
                publi:{ativa:el('checkPubli').checked, img:el('imgPubli').value},
                linkMapa:el('linkMapa').value, telFixo:el('telFixo').value, cidade:el('cidade').value
            };
            if(currentUser.role==='owner') d.ownerId = currentUser.userId;
            if(idEditando) await updateDoc(doc(db,"guia_cidades",idEditando),d); else await addDoc(collection(db,"guia_cidades"),d);
            alert("Salvo!"); limparForm();
        };

        // EDITAR (PREENCHER DESCRI√á√ÉO)
        window.editLocal=(id,j)=>{
            const d=JSON.parse(decodeURIComponent(j)); idEditando=id;
            el('tituloForm').textContent="‚úèÔ∏è Editando: "+d.nome;
            el('selCidadeCadastro').value=d.cidadeId; el('nome').value=d.nome; 
            
            // NOVO CAMPO CARREGADO
            el('descricao').value = d.descricao || "";
            
            el('cidade').value=d.cidade||""; el('categoria').value=d.categoria; el('categoria').dispatchEvent(new Event('change')); setTimeout(()=>{el('subcategoria').value=d.subcategoria; el('subcategoria').dispatchEvent(new Event('change')); el('setor').value=d.setor;},500); el('imagem').value=d.imagem; el('linkMapa').value=d.linkMapa||""; el('contato').value=d.contato||""; el('telFixo').value=d.telFixo||""; el('instagram').value=d.instagram||""; el('precoAtual').value=d.preco||""; el('precoAntigo').value=d.precoAntigo||""; el('checkPartner').checked=d.isPartner; el('checkPubli').checked=d.publi?.ativa; el('imgPubli').value=d.publi?.img||""; if(d.publi?.ativa) el('boxPubli').style.display='block'; el('checkDelivery').checked=d.temDelivery; if(d.temDelivery) el('boxInfoDelivery').style.display='block'; cardapio = d.cardapio || []; renderMenu(); atualizarSelectBrindes(); el('deliveryBrinde').value=d.deliveryBrinde||""; el('btnSalvar').innerText="Atualizar Dados"; el('btnCancelar').style.display='inline'; el('painelCadastro').scrollIntoView({behavior:'smooth'});
        };

        window.limparForm=()=>{idEditando=null; el('tituloForm').textContent="üè™ Cadastrar Local"; el('nome').value=""; el('descricao').value=""; el('cidade').value=""; el('imagem').value=""; el('btnSalvar').innerText="Cadastrar"; el('btnCancelar').style.display='none';el('checkDelivery').checked=false; el('boxInfoDelivery').style.display='none';cardapio=[]; renderMenu(); atualizarSelectBrindes();};
        window.delLocal=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"guia_cidades",id));};
        window.verificarTermosDelivery = (chk) => { if(chk.checked){el('modalTermos').style.display='flex'; chk.checked=false;} else {el('boxInfoDelivery').style.display='none';} };
        window.aceitarTermos = () => { el('checkDelivery').checked=true; el('boxInfoDelivery').style.display='block'; el('modalTermos').style.display='none'; };
        window.recusarTermos = () => { el('modalTermos').style.display='none'; };
        el('checkPubli').onchange=e=>el('boxPubli').style.display=e.target.checked?'block':'none';
        
        // ... (RESTO DAS FUN√á√ïES DE CONFIG, USU√ÅRIO E CATEGORIAS MANTIDAS IGUAIS) ...
        function renderCats(){const d=el('listaGestaoCategorias');d.innerHTML="";(listaSubs["_order"]||[]).forEach(c=>{let ic=customIcons[c]||"üìÇ";d.innerHTML+=`<div class="cat-block"><div class="cat-header"><div style="font-weight:bold; font-size:15px;">${ic} ${c}</div><div class="cat-actions"><button class="btn btn-info btn-sm" onclick="openIcon('${c}')">Icon</button><button class="btn btn-warning btn-sm" onclick="editCat('${c}')">‚úèÔ∏è</button><button class="btn btn-secondary btn-sm" onclick="toggleSubs('${c}')">Subs</button><button class="btn btn-danger btn-sm" onclick="delCat('${c}')">X</button></div></div><div id="subs-${c}" class="sub-manager-container">${(listaSubs[c]||[]).map((s,i)=>`<div class="sub-item"><div>${s}</div><div><button class="btn btn-secondary btn-sm" style="padding:2px 6px; font-size:10px;" onclick="toggleSetores('${s}')">Setores</button><button class="btn btn-danger btn-sm" style="padding:2px 6px; font-size:10px;" onclick="delSub('${c}',${i})">X</button></div></div><div id="setores-${s}" class="sector-manager-container">${(listaSetores[s]||[]).map((st,sti)=>`<div class="sector-item"><span>${st}</span> <button class="btn btn-danger btn-sm" style="padding:0 4px; font-size:10px;" onclick="delSetor('${s}',${sti})">x</button></div>`).join('')}<div style="display:flex; gap:5px; margin-top:5px;"><input id="new-setor-${s}" class="input-inline" placeholder="Novo Setor"><button class="btn btn-success btn-sm" style="padding:2px 6px;" onclick="addSetor('${s}')">+</button></div></div>`).join('')}<div style="display:flex; gap:5px; margin-top:10px; border-top:1px solid #ddd; padding-top:10px;"><input id="new-sub-${c}" placeholder="Nova Sub" style="flex:1; padding:8px;"><button class="btn btn-success btn-sm" onclick="addSub('${c}')">+ Add</button></div></div></div>`;}); updateSel();}
        window.openIcon=c=>{catEditing=c;el('modalIconPicker').style.display='flex';el('inputCustomIcon').value=customIcons[c]||"";el('inputCustomIcon').focus();};
        window.closeIconPicker=()=>el('modalIconPicker').style.display='none';
        window.salvarIconeCustomizado=async()=>{const v=el('inputCustomIcon').value.trim();if(v)customIcons[catEditing]=v;else delete customIcons[catEditing];await setDoc(doc(db,"config","icons"),customIcons);closeIconPicker();};
        window.adicionarCategoria=async()=>{const n=el('novaCategoriaInput').value.trim();if(!n)return;if(!listaSubs["_order"])listaSubs["_order"]=[];listaSubs["_order"].push(n);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();el('novaCategoriaInput').value="";};
        window.delCat=async(n)=>{if(confirm("Apagar?")){listaSubs["_order"]=listaSubs["_order"].filter(x=>x!==n);delete listaSubs[n];await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.editCat=async(old)=>{const n=prompt("Novo nome:",old);if(n&&n!==old){if(listaSubs[n])return alert("Existe");listaSubs[n]=listaSubs[old];delete listaSubs[old];const i=listaSubs["_order"].indexOf(old);if(i!==-1)listaSubs["_order"][i]=n;await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.toggleSubs=id=>{const x=document.getElementById('subs-'+id);x.style.display=x.style.display==='block'?'none':'block';};
        window.toggleSetores=id=>{const x=document.getElementById('setores-'+id);x.style.display=x.style.display==='block'?'none':'block';};
        window.addSub=async(c)=>{const v=document.getElementById('new-sub-'+c).value.trim();if(!v)return;if(!listaSubs[c])listaSubs[c]=[];listaSubs[c].push(v);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();};
        window.delSub=async(c,i)=>{if(confirm("Apagar?")){listaSubs[c].splice(i,1);await setDoc(doc(db,"config","categorias"),listaSubs);renderCats();}};
        window.addSetor=async(s)=>{const v=document.getElementById('new-setor-'+s).value.trim();if(!v)return;if(!listaSetores[s])listaSetores[s]=[];listaSetores[s].push(v);await setDoc(doc(db,"config","setores"),listaSetores);renderCats();};
        window.delSetor=async(s,i)=>{if(confirm("Apagar?")){listaSetores[s].splice(i,1);await setDoc(doc(db,"config","setores"),listaSetores);renderCats();}};
        el('categoria').onchange=()=>{const c=el('categoria').value; const s=el('subcategoria'); s.innerHTML='<option value="">Selecione...</option>'; s.disabled=true; if(c&&listaSubs[c]){s.disabled=false;listaSubs[c].forEach(x=>s.innerHTML+=`<option value="${x}">${x}</option>`);}};
        el('subcategoria').onchange=()=>{const s=el('subcategoria').value; const st=el('setor'); st.innerHTML='<option value="">Selecione...</option>'; st.disabled=true; if(s&&listaSetores[s]){st.disabled=false;listaSetores[s].forEach(x=>st.innerHTML+=`<option value="${x}">${x}</option>`);}};
        function updateSel(){const s=el('categoria');const v=s.value;s.innerHTML='<option value="">Selecione...</option>';(listaSubs["_order"]||[]).forEach(c=>s.innerHTML+=`<option value="${c}">${c}</option>`);s.value=v;}
        window.salvarVip=async()=>{const n=el('vipNome').value,e=el('vipEmail').value,p=el('vipPalavra').value,ph=el('vipPhone').value;if(!n||!p)return alert("Obrigat√≥rios");const d={nome:n,email:e,nasc:el('vipNasc').value,palavra:p,whatsapp:ph};if(idVipEditando)await updateDoc(doc(db,"vips",idVipEditando),d);else await addDoc(collection(db,"vips"),d);alert("Salvo");cancelarEdicaoVip();};
        window.editVip=(id,n,d,e,p,ph)=>{idVipEditando=id;el('vipNome').value=n;el('vipNasc').value=d;el('vipEmail').value=e;el('vipPalavra').value=p;el('vipPhone').value=ph||"";el('btnSalvarVip').textContent="Atualizar";el('btnCancelVip').style.display='inline';};
        window.cancelarEdicaoVip=()=>{idVipEditando=null;el('vipNome').value="";el('vipPalavra').value="";el('vipPhone').value="";el('btnSalvarVip').textContent="Cadastrar VIP";el('btnCancelVip').style.display='none';};
        window.delVip=async(id)=>{if(confirm("Apagar?"))await deleteDoc(doc(db,"vips",id));};
        window.salvarConfigGlobal=async()=>{await setDoc(doc(db,"config","geral"),{titulo:el('confNomeCidade').value,zapAdmin:el('confZapAdmin').value,opacAzul:el('opacAzul').value,opacPreto:el('opacPreto').value,headerSize:el('confHeaderSize').value,headerTop:el('confHeaderTop').value,sponsorSize:el('confSponsorSize').value,sponsorBottom:el('confSponsorBottom').value},{merge:true});alert("Salvo");};
        window.salvarCidade=async()=>{await addDoc(collection(db,"cidades"),{nome:el('novaCidadeNome').value,uf:el('novaCidadeUF').value,login:el('novaCidadeLogin').value,senha:el('novaCidadeSenha').value});alert("Cidade Salva");};
        window.prepararEdicaoUsuario = (id, nome, email, senha, cidadeId) => { idUsuarioEditando = id; el('editUserName').value = nome; el('editUserEmail').value = email; el('editUserPass').value = senha; el('editUserCidade').value = cidadeId; el('formEditUser').style.display = 'block'; };
        window.cancelarEdicaoUsuario = () => { idUsuarioEditando = null; el('formEditUser').style.display = 'none'; };
        window.salvarEdicaoUsuario = async () => { if(!idUsuarioEditando) return; const nome = el('editUserName').value.trim(); const senha = el('editUserPass').value.trim(); const cidadeId = el('editUserCidade').value; await updateDoc(doc(db, "users", idUsuarioEditando), { nome, senha, cidadeId }); alert("Atualizado!"); cancelarEdicaoUsuario(); };
    </script>
</body>
</html>