<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Gest√£o</title>
    <style>
        * { -webkit-user-select: none; user-select: none; box-sizing: border-box; }
        input, textarea, select { -webkit-user-select: text; user-select: text; }
        body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #e9ecef; max-width: 800px; margin: 0 auto; }
        
        /* LOGIN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #222; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .login-box { text-align: center; background: #333; padding: 40px 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); width: 90%; max-width: 350px; position: relative; }
        .login-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: none; font-size: 16px; }
        .btn-login { background: #007bff; color: white; padding: 12px; width: 100%; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }
        .login-logo { max-width: 150px; max-height: 100px; object-fit: contain; margin-bottom: 20px; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }

        /* GERAL */
        .header-admin { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; display: none; }
        .btn-home { text-decoration: none; background: #333; color: white; padding: 10px 15px; border-radius: 8px; font-weight: bold; font-size: 14px; }
        .badge-role { background: #ffc107; color: #333; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: bold; margin-left: 10px; }

        .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.05); margin-bottom: 25px; display: none; }
        h2 { margin-top: 0; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px; }
        h3 { color: #555; font-size: 16px; margin-bottom: 10px; border-left: 4px solid #6f42c1; padding-left: 8px; }
        
        input, select, textarea { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 6px; }
        label { font-weight: 500; font-size: 14px; color: #555; margin-top: 10px; display: block; }
        .row { display: flex; gap: 10px; } .col { flex: 1; }

        .manager-item { display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; padding: 10px; border: 1px solid #eee; margin-bottom: 5px; border-radius: 6px; }
        .item-lista { display: flex; justify-content: space-between; align-items: center; background: #fff; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid #007bff; }

        /* SUBS e SETORES */
        .sub-manager-container { display: none; background: #fff; margin: 5px 0 15px 20px; padding: 10px; border-left: 3px solid #17a2b8; }
        .sub-item { display: flex; justify-content: space-between; align-items: center; padding: 5px 0; border-bottom: 1px solid #eee; font-size: 13px; color: #555; }
        .sector-manager-container { display: none; background: #f1f8ff; margin: 5px 0 10px 20px; padding: 8px; border-left: 3px solid #28a745; border-radius: 4px; }
        .sector-item { display: flex; justify-content: space-between; align-items: center; padding: 3px 0; border-bottom: 1px solid #ddd; font-size: 12px; color: #333; }
        .input-sub-add { width: 70% !important; padding: 8px !important; font-size: 13px !important; margin: 0 !important; }

        button { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; color: white; margin-top: 10px; }
        .btn-success { background: #28a745; } .btn-warning { background: #ffc107; color: #333; display: inline-block; } .btn-danger { background: #dc3545; display: inline-block; }
        .btn-info { background: #17a2b8; color: white; display: inline-block; }
        .btn-sector { background: #28a745; color: white; display: inline-block; font-size: 10px; padding: 3px 8px !important; margin-right: 5px; }
        .btn-mini { width: auto !important; padding: 5px 10px !important; display: inline-block !important; margin-left: 5px; }
        
        .box-highlight { padding: 15px; border-radius: 8px; display: none; margin-top: 15px; }
        .delivery-box { background: #fff3cd; border: 1px solid #ffeeba; }
        .publi-box { background: #d4edda; border: 1px solid #c3e6cb; }
        .item-cardapio { display: flex; justify-content: space-between; align-items: center; background: white; padding: 10px; margin: 8px 0; border-radius: 6px; border: 1px solid #ddd; }
        .validade-info { font-weight: bold; color: #155724; font-size: 13px; margin-top: 5px; text-align: right; }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div style="position:absolute; top:0; left:0; width:100%; padding:20px; display:flex; justify-content:space-between; align-items:center;">
            <div style="display:flex; align-items:center; gap:10px; font-size:20px; font-weight:bold;">
                <img src="logo.png" style="height:30px; width:auto;" alt="Logo"> <span>Guia</span>
            </div>
            <button onclick="window.location.href='index.html'" style="background:none; border:none; color:white; font-size:28px; cursor:pointer; width:auto; padding:0; margin:0;">‚úï</button>
        </div>

        <div class="login-box">
            <div style="text-align:center;">
                <img src="logo.png" class="login-logo" alt="Logo do App">
            </div>
            <div style="position: relative;">
                <input type="text" id="inputUsuario" class="login-input" placeholder="Usu√°rio ou E-mail">
                <span id="btnLimparLogin" onclick="limparLoginSalvo()" style="position:absolute; right:10px; top:50%; transform:translateY(-50%); color:#999; cursor:pointer; font-size:12px; font-weight:bold; display:none;" title="Limpar">‚úï</span>
            </div>
            <input type="password" id="inputSenha" class="login-input" placeholder="Senha">
            <button class="btn-login" onclick="fazerLogin()">Acessar Painel</button>
            <p id="msgLogin" style="color:#ff6b6b; font-size:14px; margin-top:10px;"></p>
        </div>
    </div>

    <div class="header-admin" id="headerAdmin">
        <div><h2 style="border:none; margin:0;">Painel de Gest√£o</h2><span id="roleBadge" class="badge-role">...</span></div>
        <a href="index.html" class="btn-home">üè† Ver App</a>
    </div>

    <div class="card" id="painelCidades" style="border-top: 5px solid #ff5722;">
        <h2>üèôÔ∏è Gerenciar Cidades</h2>
        <div id="listaCidades"></div>
        <h3 id="tituloCidadeForm" style="margin-top:20px;">Nova Cidade / Editar</h3>
        <div class="row"><input type="text" id="novaCidadeNome" placeholder="Nome" class="col"><input type="text" id="novaCidadeUF" placeholder="UF" style="width: 80px;"></div>
        <div class="row"><input type="text" id="novaCidadeFundo" placeholder="Link Fundo" class="col"><input type="text" id="novaCidadeLogo" placeholder="Link Logo" class="col"></div>
        <label>Config Logo Patrocinador:</label>
        <div class="row"><input type="number" id="novaCidadeLogoSize" placeholder="Tam % (30)" style="flex: 1;"><input type="number" id="novaCidadeLogoBottom" placeholder="Pos % (15)" style="flex: 1;"></div>
        <label>Acesso Local:</label>
        <div class="row"><input type="text" id="novaCidadeLogin" placeholder="Usu√°rio" class="col"><input type="text" id="novaCidadeSenha" placeholder="Senha" class="col"></div>
        <div style="display:flex; gap:10px;"><button id="btnSalvarCidade" class="btn-success" onclick="salvarCidade()">+ Cadastrar</button><button id="btnCancelarCidade" class="btn-danger" style="display:none;" onclick="cancelarEdicaoCidade()">Cancelar</button></div>
    </div>

    <div class="card" id="painelUsuarios" style="border-top: 5px solid #28a745; display:none;">
        <h2>üë• Usu√°rios</h2>
        <div id="listaUsuarios"></div>
        <div id="formEditUser" style="display:none; background:#f0f8ff; padding:15px; border-radius:10px; margin-top:20px;">
            <h3>‚úèÔ∏è Editando</h3>
            <input type="text" id="editUserName" placeholder="Nome"><input type="text" id="editUserEmail" disabled style="background:#eee;">
            <input type="text" id="editUserPass" placeholder="Nova Senha">
            <label>Cidade:</label><select id="editUserCidade"><option value="">Selecione...</option></select>
            <div style="display:flex; gap:10px;"><button class="btn-success" onclick="salvarEdicaoUsuario()">Salvar</button><button class="btn-danger" onclick="cancelarEdicaoUsuario()">Cancelar</button></div>
        </div>
    </div>

    <div class="card" id="painelCategorias" style="border-top: 5px solid #17a2b8;">
        <h2>üìÇ Categorias, Subs e Setores</h2>
        <div id="listaGestaoCategorias"></div>
        <div class="row"><input type="text" id="novaCategoriaInput" placeholder="Nome Categoria" class="col"><button class="btn-success" style="width:auto; margin-top:8px;" onclick="adicionarCategoria()">Criar</button></div>
    </div>

    <div class="card" id="painelMasterConfig" style="border-top: 5px solid #6f42c1;">
        <h2>‚öôÔ∏è Global</h2>
        <input type="text" id="confNomeCidade" placeholder="Nome App">
        <label>Degrad√™:</label><div class="row"><input type="range" id="opacAzul" min="0" max="100" class="col"><input type="range" id="opacPreto" min="0" max="100" class="col"></div>
        <h3>üñºÔ∏è Logo Topo</h3>
        <div class="row"><div class="col"><label>Altura (px):</label><input type="number" id="confLogoHeight"></div><div class="col"><label>Posi√ß√£o Y (px):</label><input type="number" id="confLogoTop"></div></div>
        <button onclick="salvarConfigGlobal()" style="background:#6f42c1">Salvar Configura√ß√µes</button>
    </div>

    <div class="card" id="painelCadastro" style="display:block;">
        <h2 id="tituloForm">üè™ Gerenciar Cadastro</h2>
        
        <label style="color:#ff5722;">1. Cidade:</label>
        <select id="selCidadeCadastro" style="border: 2px solid #ff5722; font-weight:bold;"><option value="">Selecione...</option></select>

        <label style="color:#007bff;">2. Categoria:</label>
        <select id="categoria" style="border: 2px solid #007bff;"><option value="">Selecione...</option></select>

        <label>Subcategoria:</label>
        <select id="subcategoria" disabled><option value="">Selecione categoria...</option></select>

        <label>Setor (Opcional):</label>
        <select id="setor" disabled><option value="">Selecione subcategoria...</option></select>

        <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">

        <label id="lblNome">Nome:</label><input type="text" id="nome">
        <div class="row"><input type="number" id="precoAntigo" placeholder="Pre√ßo Riscado" class="col"><input type="number" id="precoAtual" placeholder="Pre√ßo Atual" class="col"></div>
        <label id="lblCidade">Endere√ßo / Descri√ß√£o:</label><input type="text" id="cidade">
        <input type="text" id="linkMapa" placeholder="Link do Google Maps (Opcional)">
        <label>Fotos (URL por linha):</label><textarea id="imagem" rows="3"></textarea>
        <label>Contatos:</label><div class="row"><input type="text" id="contato" placeholder="WhatsApp" class="col"><input type="text" id="telFixo" placeholder="Fixo" class="col"></div>
        <div id="divInsta"><input type="text" id="instagram" placeholder="Instagram Link"></div>

        <div style="margin-top:15px; display:flex; gap:10px;">
            <input type="checkbox" id="checkDelivery" style="width:20px; height:20px;"> <label for="checkDelivery" style="margin:0">Delivery?</label>
            <input type="checkbox" id="checkPubli" style="width:20px; height:20px;"> <label for="checkPubli" style="margin:0">Banner?</label>
        </div>
        <input type="number" id="taxaEntrega" placeholder="Taxa Entrega" style="display:none; margin-top:5px;">

        <div id="boxPubli" class="box-highlight publi-box">
            <input type="text" id="imgPubli" placeholder="Link Banner">
            <div class="row"><select id="tipoValidade" class="col"><option value="dias">Dias</option><option value="data">Data</option></select><input type="number" id="valorValidade" placeholder="Qtd" class="col"><input type="date" id="dataEspecifica" class="col" style="display:none"></div>
            <div id="contadorPubli" class="validade-info"></div><button onclick="removerPubli()" style="background:#dc3545; width:auto; float:right;">üóëÔ∏è Remover</button><div style="clear:both"></div>
        </div>

        <div id="boxDelivery" class="box-highlight delivery-box">
            <h3>üçî Card√°pio</h3>
            <div class="row"><input type="text" id="prodNome" placeholder="Item" class="col"><input type="number" id="prodPreco" placeholder="$$" style="width:80px"></div>
            <input type="text" id="prodDesc" placeholder="Descri√ß√£o"><input type="text" id="prodImg" placeholder="Foto URL">
            <button id="btnAddItem" style="background:#17a2b8; width:auto; float:right;">Adicionar</button>
            <div id="lista-cardapio-preview" style="clear:both; margin-top:10px;"></div>
        </div>

        <button id="btnSalvar" class="btn-success">Cadastrar</button>
        <button id="btnAtualizar" class="btn-warning">Salvar Altera√ß√µes</button>
        <button id="btnCancelar" class="btn-danger">Cancelar</button>
    </div>

    <div class="card" id="painelLista" style="display:block;"><h3>üìã Cadastros</h3><div id="lista-locais"></div></div>
    <div class="card" id="painelDanger" style="border: 2px solid red; background: #fff5f5; text-align: center;"><h3>‚ö†Ô∏è Zona de Perigo</h3><button onclick="zerarBanco()" style="background:red; color:white;">üî• RESETAR</button></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, deleteDoc, updateDoc, doc, getDoc, setDoc, onSnapshot, query, orderBy, where, getDocs, writeBatch } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw", authDomain: "testegithub-e1ffb.firebaseapp.com", projectId: "testegithub-e1ffb", storageBucket: "testegithub-e1ffb.firebasestorage.app", messagingSenderId: "508103458559", appId: "1:508103458559:web:55bc2fe4dc61d7b5ee16ca" };
        const app = initializeApp(firebaseConfig); const db = getFirestore(app);
        const el = (id) => document.getElementById(id);
        const IMG_PADRAO_CIDADE = "https://images.unsplash.com/photo-1505142468610-359e7d316be0?q=80&w=3070&auto=format&fit=crop&ixlib=rb-4.1.0&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D";

        let currentUser = null; 
        let idEditando = null, cardapioAtual = [], listaSubs = {}, listaSetores = {}, itemMenuEditandoIndex = -1;
        let idCidadeEditando = null, idUsuarioEditando = null, mapCidades = {};

        // === 1. L√ìGICA DE LOGIN RESTAURADA ===
        setTimeout(() => { if(el('inputUsuario')) el('inputUsuario').focus(); }, 300);
        
        // Verifica se h√° login salvo
        const savedLogin = localStorage.getItem('saved_login_user');
        if(savedLogin && el('inputUsuario')) { 
            el('inputUsuario').value = savedLogin; 
            if(el('btnLimparLogin')) el('btnLimparLogin').style.display = 'block'; 
        }

        window.limparLoginSalvo = () => { localStorage.removeItem('saved_login_user'); el('inputUsuario').value = ""; el('btnLimparLogin').style.display = 'none'; el('inputUsuario').focus(); };

        window.fazerLogin = async () => {
            const user = el('inputUsuario').value.trim(); 
            const pass = el('inputSenha').value; // SEM TRIM NA SENHA PARA EVITAR ERROS
            const msg = el('msgLogin'); 
            msg.textContent = "Verificando...";

            if(!user || !pass) { msg.textContent = "Preencha todos os campos."; return; }

            try {
                // 1. MASTER
                if(user === 'master' && pass === 'master123') { 
                    currentUser = { role: 'master', name: 'Master Admin' }; 
                    salvarEEntrar(user); return; 
                }

                // 2. CIDADE
                const qCity = query(collection(db, "cidades"), where("login", "==", user), where("senha", "==", pass));
                const snapCity = await getDocs(qCity);
                if(!snapCity.empty) { 
                    const docData = snapCity.docs[0].data(); 
                    currentUser = { role: 'city', cityId: snapCity.docs[0].id, cityName: docData.nome }; 
                    salvarEEntrar(user); return; 
                }

                // 3. OWNER (USU√ÅRIO)
                const qUser = query(collection(db, "users"), where("email", "==", user), where("senha", "==", pass));
                const snapUser = await getDocs(qUser);
                if(!snapUser.empty) { 
                    const docData = snapUser.docs[0].data(); 
                    currentUser = { role: 'owner', userId: snapUser.docs[0].id, name: docData.nome, cityId: docData.cidadeId }; 
                    salvarEEntrar(user); return; 
                }

                msg.textContent = "Usu√°rio ou senha incorretos.";
            } catch(e) { 
                console.error("Erro login:", e); 
                msg.textContent = "Erro de conex√£o. Tente novamente."; 
            }
        };

        function salvarEEntrar(userLogin) { 
            localStorage.setItem('saved_login_user', userLogin); 
            iniciarAdmin(); 
        }

        function iniciarAdmin() {
            el('loginScreen').style.display = 'none'; 
            el('headerAdmin').style.display = 'flex'; 
            el('roleBadge').textContent = currentUser.role === 'master' ? 'üëë Master' : (currentUser.role === 'city' ? `üìç ${currentUser.cityName}` : `üë§ ${currentUser.name}`);
            
            // Controle de visualiza√ß√£o
            el('painelCidades').style.display = currentUser.role === 'master' ? 'block' : 'none'; 
            el('painelMasterConfig').style.display = currentUser.role === 'master' ? 'block' : 'none'; 
            el('painelUsuarios').style.display = currentUser.role === 'master' ? 'block' : 'none'; 
            el('painelDanger').style.display = currentUser.role === 'master' ? 'block' : 'none';
            
            el('painelCategorias').style.display = (currentUser.role === 'master' || currentUser.role === 'city') ? 'block' : 'none';
            
            el('painelCadastro').style.display = 'block'; 
            el('painelLista').style.display = 'block';

            carregarCidadesAdmin(); 
            carregarCategorias(); 
            if(currentUser.role === 'master') { carregarConfigGeral(); carregarUsuariosMaster(); } 
            
            iniciarListenerLocais();
        }

        // === 2. CATEGORIAS E SUBCATEGORIAS (CORRIGIDO) ===
        async function carregarCategorias() { 
            const docSnap = await getDoc(doc(db, "config", "categorias"));
            listaSubs = docSnap.exists() ? docSnap.data() : { "Comercio": [], "_order": ["Comercio"] };
            const docSetores = await getDoc(doc(db, "config", "setores"));
            listaSetores = docSetores.exists() ? docSetores.data() : {};
            renderCategorias(); 
            atualizarSelectCat(); // Popula o select inicial
        }

        function actualizarSelectCat() { // Alias para evitar erro de digita√ß√£o
            atualizarSelectCat();
        }

        function atualizarSelectCat() {
            const sel = el('categoria'); 
            if(!sel) return;
            const val = sel.value; 
            sel.innerHTML = '<option value="">Selecione...</option>';
            let ordem = listaSubs["_order"] || Object.keys(listaSubs).filter(k => k !== "_order").sort();
            ordem.forEach(c => sel.innerHTML += `<option value="${c}">${c}</option>`);
            sel.value = val;
        }

        // --- L√ìGICA DE MUDAN√áA DE CATEGORIA (CORRIGIDA) ---
        el('categoria').addEventListener('change', () => {
            const cat = el('categoria').value;
            // Ajuste de Labels
            if(cat === 'Classificados') { el('lblNome').textContent = "Produto:"; el('lblCidade').textContent = "Descri√ß√£o:"; el('divInsta').style.display='none'; } 
            else if(cat === 'Profissionais') { el('lblNome').textContent = "Profissional:"; el('lblCidade').textContent = "Qualifica√ß√£o:"; el('divInsta').style.display='block'; } 
            else { el('lblNome').textContent = "Local:"; el('lblCidade').textContent = "Endere√ßo:"; el('divInsta').style.display='block'; }
            
            const sub = el('subcategoria');
            sub.innerHTML = '<option value="">Selecione...</option>';
            el('setor').innerHTML = '<option value="">Selecione subcategoria...</option>'; 
            el('setor').disabled = true;

            // FOR√áA O PREENCHIMENTO E DESBLOQUEIO
            if(cat && listaSubs[cat] && listaSubs[cat].length > 0) {
                sub.disabled = false;
                listaSubs[cat].forEach(s => sub.innerHTML += `<option value="${s}">${s}</option>`);
            } else {
                sub.innerHTML = '<option value="">Sem subcategorias</option>';
                sub.disabled = true;
            }
        });

        // POPULA SETORES AO MUDAR SUB
        el('subcategoria').addEventListener('change', () => {
            const sub = el('subcategoria').value;
            const setorSel = el('setor');
            setorSel.innerHTML = '<option value="">Selecione...</option>';
            
            if(sub && listaSetores[sub] && listaSetores[sub].length > 0) {
                setorSel.disabled = false;
                setorSel.innerHTML = '<option value="">Sem setor (Opcional)</option>';
                listaSetores[sub].forEach(s => setorSel.innerHTML += `<option value="${s}">${s}</option>`);
            } else {
                setorSel.innerHTML = '<option value="">Nenhum setor dispon√≠vel</option>';
                setorSel.disabled = true;
            }
        });

        // --- SALVAMENTO E CADASTRO ---
        const salvarOuAtualizar = async (isUpdate) => {
            const btn = isUpdate ? el('btnAtualizar') : el('btnSalvar'); const txtOriginal = btn.textContent;
            try {
                let cidadeIdFinal = el('selCidadeCadastro').value;
                if((currentUser.role === 'city' || currentUser.role === 'owner') && currentUser.cityId) cidadeIdFinal = currentUser.cityId;
                if(!cidadeIdFinal) return alert("Selecione a CIDADE!"); if(!el('nome').value) return alert("Nome obrigat√≥rio");
                
                btn.textContent = "Salvando..."; btn.disabled = true;
                const imgs = el('imagem').value.split('\n').map(s => s.trim()).filter(s => s);
                
                const dados = { cidadeId: cidadeIdFinal, nome: el('nome').value, nomeBusca: el('nome').value.toLowerCase(), cidade: el('cidade').value, categoria: el('categoria').value, subcategoria: el('subcategoria').value, setor: el('setor').value || "", contato: el('contato').value, telFixo: el('telFixo').value, instagram: el('instagram').value, imagem: imgs[0] || "https://via.placeholder.com/150", imagens: imgs, preco: parseFloat(el('precoAtual').value) || 0, precoAntigo: parseFloat(el('precoAntigo').value) || 0, temDelivery: el('checkDelivery').checked, taxaEntrega: parseFloat(el('taxaEntrega').value) || 0, cardapio: cardapioAtual, publi: { ativa: el('checkPubli').checked, img: el('imgPubli').value, dataFim: calcularDataFimPubli() }, linkMapa: el('linkMapa').value || "", dataCadastro: new Date() };
                
                if(currentUser.role === 'owner') dados.ownerId = currentUser.userId;
                if(isUpdate) await updateDoc(doc(db, "guia_cidades", idEditando), dados); else await addDoc(collection(db, "guia_cidades"), dados);
                alert("Salvo com sucesso!"); limparForm();
            } catch(e) { console.error(e); alert("Erro ao salvar: " + e.message); } finally { btn.textContent = txtOriginal; btn.disabled = false; }
        };
        el('btnSalvar').onclick = () => salvarOuAtualizar(false); el('btnAtualizar').onclick = () => salvarOuAtualizar(true);

        function limparForm() {
            idEditando=null; cardapioAtual=[]; itemMenuEditandoIndex=-1;
            el('nome').value=""; el('imagem').value=""; el('precoAtual').value=""; el('precoAntigo').value=""; el('cidade').value=""; el('linkMapa').value=""; el('contato').value=""; el('telFixo').value=""; el('instagram').value=""; el('imgPubli').value=""; 
            el('checkPubli').checked=false; el('checkDelivery').checked=false; el('boxPubli').style.display='none'; el('boxDelivery').style.display='none'; el('taxaEntrega').value=""; el('taxaEntrega').style.display='none';
            
            // RESET SELECTS
            el('categoria').value=""; 
            el('subcategoria').innerHTML = '<option value="">Selecione categoria...</option>'; el('subcategoria').disabled = true; 
            el('setor').innerHTML = '<option value="">Selecione subcategoria...</option>'; el('setor').disabled = true;
            
            el('btnSalvar').style.display='block'; el('btnAtualizar').style.display='none'; el('btnCancelar').style.display='none'; el('tituloForm').textContent="üè™ Gerenciar Cadastro";
            el('prodNome').value=""; el('prodPreco').value=""; el('prodDesc').value=""; el('prodImg').value=""; el('btnAddItem').textContent="Adicionar"; el('lista-cardapio-preview').innerHTML="";
            configurarSeletorCidades();
        }
        el('btnCancelar').onclick = limparForm;

        // ... DEMAIS FUN√á√ïES DO SISTEMA ...
        function renderCategorias() { const div = el('listaGestaoCategorias'); div.innerHTML = ""; let ordem = listaSubs["_order"] || Object.keys(listaSubs).filter(k => k !== "_order").sort(); ordem.forEach((cat, index) => { if(cat === "_order") return; let html = `<div class="manager-item"><div><b>${cat}</b> <button class="btn-mini btn-warning" onclick="editCat('${cat}')">‚úèÔ∏è</button></div><div><button class="btn-info" style="width:auto; padding:5px 10px;" onclick="toggleSubs('${cat}')">üìÇ Subs</button><button class="btn-mini" onclick="moverCat(${index},-1)">‚ñ≤</button><button class="btn-mini" onclick="moverCat(${index},1)">‚ñº</button><button class="btn-mini btn-danger" onclick="delCat('${cat}')">‚úï</button></div></div><div id="subs-${cat}" class="sub-manager-container">`; const subs = listaSubs[cat] || []; if(subs.length === 0) { html += `<div style="font-size:12px; color:#999; margin-bottom:10px;">Nenhuma subcategoria.</div>`; } else { subs.forEach((sub, subIdx) => { html += `<div class="sub-item"><div><span>${sub}</span> <button class="btn-mini btn-warning" onclick="editSub('${cat}', ${subIdx})">‚úèÔ∏è</button> <button class="btn-sector" onclick="toggleSetores('${sub}')">üìÇ Setores</button></div><button class="btn-mini btn-danger" onclick="delSub('${cat}', ${subIdx})">‚úï</button></div><div id="setores-${sub}" class="sector-manager-container"><b>Setores de ${sub}:</b><div id="list-setores-${sub}"></div><div style="display:flex; gap:5px; margin-top:5px;"><input type="text" id="new-setor-${sub}" class="input-sub-add" placeholder="Novo Setor"><button class="btn-success btn-mini" style="margin:0;" onclick="addSetor('${sub}')">Add</button></div></div>`; setTimeout(() => renderListaSetores(sub), 100); }); } html += `<div style="display:flex; gap:5px; margin-top:10px;"><input type="text" id="new-sub-${cat}" class="input-sub-add" placeholder="Nova Subcategoria"><button class="btn-success btn-mini" style="margin:0;" onclick="addSub('${cat}')">Add</button></div></div>`; div.innerHTML += html; }); }
        
        // Carregamento para Edi√ß√£o (Otimizado)
        window.carregarParaEdicao = (id, item) => { try { idEditando = id; el('selCidadeCadastro').value = item.cidadeId; el('categoria').value = item.categoria; const sub = el('subcategoria'); sub.innerHTML = '<option value="">Selecione...</option>'; if(item.categoria && listaSubs[item.categoria]) { sub.disabled = false; listaSubs[item.categoria].forEach(s => sub.innerHTML += `<option value="${s}">${s}</option>`); } sub.value = item.subcategoria || ""; const setorSel = el('setor'); setorSel.innerHTML = '<option value="">Selecione...</option>'; if(item.subcategoria && listaSetores[item.subcategoria]) { setorSel.disabled = false; setorSel.innerHTML = '<option value="">Sem setor</option>'; listaSetores[item.subcategoria].forEach(s => setorSel.innerHTML += `<option value="${s}">${s}</option>`); setorSel.value = item.setor || ""; } else { setorSel.disabled = true; } el('nome').value = item.nome; el('cidade').value = item.cidade; el('linkMapa').value = item.linkMapa || ""; el('imagem').value = (item.imagens || [item.imagem]).join('\n'); el('precoAtual').value = item.preco || ""; el('precoAntigo').value = item.precoAntigo || ""; el('contato').value = item.contato || ""; el('telFixo').value = item.telFixo || ""; el('instagram').value = item.instagram || ""; el('checkDelivery').checked = item.temDelivery || false; el('taxaEntrega').value = item.taxaEntrega || ""; el('taxaEntrega').style.display = item.temDelivery ? 'block' : 'none'; cardapioAtual = item.cardapio || []; renderCardapio(); if(item.publi) { el('checkPubli').checked = item.publi.ativa; el('boxPubli').style.display = item.publi.ativa ? 'block' : 'none'; el('imgPubli').value = item.publi.img || ""; if(item.publi.dataFim) { let d = item.publi.dataFim.seconds ? new Date(item.publi.dataFim.seconds * 1000) : new Date(item.publi.dataFim); el('contadorPubli').textContent = `Vence em: ${d.toLocaleDateString()}`; } } el('btnSalvar').style.display = 'none'; el('btnAtualizar').style.display = 'inline-block'; el('btnCancelar').style.display = 'inline-block'; el('tituloForm').textContent = "‚úèÔ∏è Editando: " + item.nome; window.scrollTo({top: 400, behavior:'smooth'}); } catch(e) { console.error(e); alert("Erro ao editar."); } };

        // Fun√ß√µes de Gest√£o (Simplificadas para n√£o estourar limite, mas funcionais)
        window.editCat = async (oldName) => { const newName = prompt("Novo nome:", oldName); if (!newName || newName === oldName) return; if (listaSubs[newName]) return alert("J√° existe!"); listaSubs[newName] = listaSubs[oldName]; delete listaSubs[oldName]; const idx = listaSubs["_order"].indexOf(oldName); if (idx !== -1) listaSubs["_order"][idx] = newName; await setDoc(doc(db, "config", "categorias"), listaSubs); carregarCategorias(); };
        window.editSub = async (cat, index) => { const oldName = listaSubs[cat][index]; const newName = prompt("Novo nome:", oldName); if (!newName || newName === oldName) return; listaSubs[cat][index] = newName; if (listaSetores[oldName]) { listaSetores[newName] = listaSetores[oldName]; delete listaSetores[oldName]; await setDoc(doc(db, "config", "setores"), listaSetores); } await setDoc(doc(db, "config", "categorias"), listaSubs); carregarCategorias(); };
        window.editSetorItem = async (sub, index) => { const oldName = listaSetores[sub][index]; const newName = prompt("Novo nome:", oldName); if (!newName || newName === oldName) return; listaSetores[sub][index] = newName; await setDoc(doc(db, "config", "setores"), listaSetores); renderListaSetores(sub); };
        window.toggleSubs = (cat) => { const el = document.getElementById(`subs-${cat}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; };
        window.toggleSetores = (sub) => { const el = document.getElementById(`setores-${sub}`); el.style.display = el.style.display === 'block' ? 'none' : 'block'; };
        function renderListaSetores(sub) { const container = document.getElementById(`list-setores-${sub}`); if(!container) return; container.innerHTML = ""; const setores = listaSetores[sub] || []; if(setores.length === 0) { container.innerHTML = "<div style='color:#777; font-style:italic;'>Nenhum setor.</div>"; } else { setores.forEach((s, idx) => { container.innerHTML += `<div class="sector-item"><div><span>${s}</span> <button class="btn-mini btn-warning" onclick="editSetorItem('${sub}', ${idx})">‚úèÔ∏è</button></div> <button class="btn-mini btn-danger" onclick="delSetor('${sub}', ${idx})">‚úï</button></div>`; }); } }
        window.addSetor = async (sub) => { const input = document.getElementById(`new-setor-${sub}`); const val = input.value.trim(); if(!val) return; if(!listaSetores[sub]) listaSetores[sub] = []; listaSetores[sub].push(val); await setDoc(doc(db, "config", "setores"), listaSetores); input.value = ""; renderListaSetores(sub); };
        window.delSetor = async (sub, idx) => { if(!confirm("Excluir setor?")) return; listaSetores[sub].splice(idx, 1); await setDoc(doc(db, "config", "setores"), listaSetores); renderListaSetores(sub); };
        window.addSub = async (cat) => { const input = document.getElementById(`new-sub-${cat}`); const val = input.value.trim(); if(!val) return; if(!listaSubs[cat]) listaSubs[cat] = []; listaSubs[cat].push(val); await setDoc(doc(db, "config", "categorias"), listaSubs); input.value = ""; renderCategorias(); setTimeout(() => document.getElementById(`subs-${cat}`).style.display = 'block', 100); atualizarSelectCat(); };
        window.delSub = async (cat, index) => { if(!confirm("Excluir?")) return; listaSubs[cat].splice(index, 1); await setDoc(doc(db, "config", "categorias"), listaSubs); renderCategorias(); setTimeout(() => document.getElementById(`subs-${cat}`).style.display = 'block', 100); atualizarSelectCat(); };
        window.delCat = async (cat) => { if(confirm("Excluir Categoria?")) { delete listaSubs[cat]; listaSubs["_order"] = listaSubs["_order"].filter(c => c !== cat); await setDoc(doc(db, "config", "categorias"), listaSubs); renderCategorias(); atualizarSelectCat(); }};
        window.moverCat = async (i, d) => { let o = listaSubs["_order"]; let n = i+d; if(n<0||n>=o.length) return; [o[i], o[n]] = [o[n], o[i]]; listaSubs["_order"] = o; await setDoc(doc(db, "config", "categorias"), listaSubs); renderCategorias(); atualizarSelectCat(); };
        el('btnAddItem').onclick = () => { const item = { nome: el('prodNome').value, preco: parseFloat(el('prodPreco').value), desc: el('prodDesc').value, img: el('prodImg').value }; if(!item.nome || !item.preco) return alert("Preencha nome e pre√ßo!"); if(itemMenuEditandoIndex === -1) { cardapioAtual.push(item); } else { cardapioAtual[itemMenuEditandoIndex] = item; el('btnAddItem').textContent = "Adicionar"; itemMenuEditandoIndex = -1; } el('prodNome').value = ""; el('prodPreco').value = ""; el('prodDesc').value = ""; el('prodImg').value = ""; renderCardapio(); };
        function renderCardapio() { const d = el('lista-cardapio-preview'); d.innerHTML = ""; cardapioAtual.forEach((i, x) => { d.innerHTML += `<div class="item-cardapio"><div><b>${i.nome}</b> - R$ ${i.preco}</div><div><button class="btn-mini btn-warning" onclick="prepararEdicaoItemMenu(${x})">‚úèÔ∏è</button><button class="btn-mini btn-danger" onclick="delItemMenu(${x})">X</button></div></div>`; }); }
        window.delItemMenu = (index) => { cardapioAtual.splice(index, 1); renderCardapio(); };
        window.prepararEdicaoItemMenu = (index) => { const item = cardapioAtual[index]; el('prodNome').value = item.nome; el('prodPreco').value = item.preco; el('prodDesc').value = item.desc; el('prodImg').value = item.img; itemMenuEditandoIndex = index; el('btnAddItem').textContent = "Atualizar Item"; };
        function carregarCidadesAdmin() { onSnapshot(collection(db, "cidades"), (snap) => { const div = el('listaCidades'); div.innerHTML = ""; const select = el('selCidadeCadastro'); const selectUser = el('editUserCidade'); select.innerHTML = '<option value="">Selecione...</option>'; selectUser.innerHTML = '<option value="">Selecione...</option>'; mapCidades = {}; snap.forEach(doc => { const cid = doc.data(); mapCidades[doc.id] = cid.nome; if(currentUser && currentUser.role === 'master') { div.innerHTML += `<div class="manager-item"><div><b>${cid.nome}</b> (${cid.uf}) <span style="font-size:12px;color:#666">User: ${cid.login}</span></div><div><button class="btn-warning" style="width:30px; display:inline-block;" onclick="prepararEdicaoCidade('${doc.id}', '${cid.nome}', '${cid.uf}', '${cid.login||''}', '${cid.senha}', '${cid.fundo||''}', '${cid.logoPatra||''}', '${cid.logoSize||''}', '${cid.logoBottom||''}')">‚úèÔ∏è</button><button class="btn-danger" style="width:30px; display:inline-block;" onclick="excluirCidade('${doc.id}', '${cid.nome}')">‚úï</button></div></div>`; } const opt = document.createElement('option'); opt.value = doc.id; opt.textContent = `${cid.nome} - ${cid.uf}`; select.appendChild(opt.cloneNode(true)); selectUser.appendChild(opt); }); configurarSeletorCidades(); }); }
        function configuringSeletorCidades() { const select = el('selCidadeCadastro'); if(currentUser && (currentUser.role === 'city' || currentUser.role === 'owner')) { if(currentUser.cityId) { select.value = currentUser.cityId; select.disabled = true; } else { select.disabled = false; } } else { select.disabled = false; } }
        window.configurarSeletorCidades = configuringSeletorCidades;
        window.prepararEdicaoCidade = (id, nome, uf, login, senha, fundo, logo, logoSize, logoBottom) => { idCidadeEditando = id; el('novaCidadeNome').value = nome; el('novaCidadeUF').value = uf; el('novaCidadeLogin').value = login; el('novaCidadeSenha').value = senha; el('novaCidadeFundo').value = fundo; el('novaCidadeLogo').value = logo; el('novaCidadeLogoSize').value = logoSize || ""; el('novaCidadeLogoBottom').value = logoBottom || ""; el('btnSalvarCidade').textContent = "Atualizar"; el('btnSalvarCidade').className = "btn-warning"; el('btnCancelarCidade').style.display = "inline-block"; el('tituloCidadeForm').textContent = "‚úèÔ∏è Editando"; el('novaCidadeLogin').disabled = false; };
        window.cancelarEdicaoCidade = () => { idCidadeEditando = null; el('novaCidadeNome').value = ""; el('novaCidadeUF').value = ""; el('novaCidadeLogin').value = ""; el('novaCidadeSenha').value = ""; el('novaCidadeFundo').value = ""; el('novaCidadeLogo').value = ""; el('novaCidadeLogoSize').value = ""; el('novaCidadeLogoBottom').value = ""; el('btnSalvarCidade').textContent = "+ Cadastrar"; el('btnSalvarCidade').className = "btn-success"; el('btnCancelarCidade').style.display = "none"; el('tituloCidadeForm').textContent = "Nova Cidade"; };
        window.salvarCidade = async () => { const nome = el('novaCidadeNome').value.trim(); const uf = el('novaCidadeUF').value.trim().toUpperCase(); const login = el('novaCidadeLogin').value.trim(); const senha = el('novaCidadeSenha').value.trim(); let fundo = el('novaCidadeFundo').value.trim(); const logoPatra = el('novaCidadeLogo').value.trim(); const logoSize = el('novaCidadeLogoSize').value.trim(); const logoBottom = el('novaCidadeLogoBottom').value.trim(); if(!nome || !uf || !senha || !login) return alert("Preencha Nome, UF, Login e Senha."); if(!fundo) fundo = IMG_PADRAO_CIDADE; const check = query(collection(db, "cidades"), where("login", "==", login)); const checkSnap = await getDocs(check); let loginEmUso = false; if(!checkSnap.empty) { if(idCidadeEditando) { if(checkSnap.docs[0].id !== idCidadeEditando) loginEmUso = true; } else { loginEmUso = true; } } if(loginEmUso) return alert(`ERRO: Usu√°rio '${login}' j√° existe.`); if(login === 'master') return alert("Login 'master' √© reservado."); const dados = { nome, uf, login, senha, fundo, logoPatra, logoSize, logoBottom }; if(idCidadeEditando) { await updateDoc(doc(db, "cidades", idCidadeEditando), dados); alert("Atualizado!"); } else { await addDoc(collection(db, "cidades"), dados); alert("Criado!"); } cancelarEdicaoCidade(); };
        window.excluirCidade = async (id, nomeCidade) => { const q = query(collection(db, "guia_cidades"), where("cidadeId", "==", id)); const snap = await getDocs(q); if(!snap.empty) { alert(`A cidade '${nomeCidade}' tem ${snap.size} locais cadastrados. Remova-os antes.`); return; } const n1 = Math.floor(Math.random()*10)+1; const n2 = Math.floor(Math.random()*10)+1; if(parseInt(prompt(`Para deletar '${nomeCidade}', resolva: ${n1}+${n2}=?`)) === (n1+n2)) { await deleteDoc(doc(db, "cidades", id)); alert("Exclu√≠da."); } };
        function carregarUsuariosMaster() { onSnapshot(collection(db, "users"), (snap) => { const div = el('listaUsuarios'); div.innerHTML = ""; if(snap.empty) { div.innerHTML = "<p>Nenhum usu√°rio cadastrado.</p>"; return; } snap.forEach(doc => { const u = doc.data(); const nomeCidade = u.cidadeId ? (mapCidades[u.cidadeId] || "ID Inv√°lido") : "<span class='tag-alert'>SEM CIDADE</span>"; div.innerHTML += `<div class="manager-item" style="border-left: 4px solid #28a745;"><div><b>${u.nome}</b> <br><span style="font-size:12px; color:#555;">${u.email}</span> | <span style="font-size:12px; font-weight:bold;">${nomeCidade}</span></div><div><button class="btn-warning" style="width:30px; display:inline-block;" onclick="prepararEdicaoUsuario('${doc.id}', '${u.nome}', '${u.email}', '${u.senha}', '${u.cidadeId||''}')">‚úèÔ∏è</button><button class="btn-danger" style="width:30px; display:inline-block;" onclick="excluirUsuario('${doc.id}', '${u.nome}')">‚úï</button></div></div>`; }); }); }
        window.prepararEdicaoUsuario = (id, nome, email, senha, cidadeId) => { idUsuarioEditando = id; el('editUserName').value = nome; el('editUserEmail').value = email; el('editUserPass').value = senha; el('editUserCidade').value = cidadeId; el('formEditUser').style.display = 'block'; el('formEditUser').scrollIntoView({ behavior: 'smooth' }); };
        window.cancelarEdicaoUsuario = () => { idUsuarioEditando = null; el('formEditUser').style.display = 'none'; el('editUserName').value = ""; el('editUserEmail').value = ""; el('editUserPass').value = ""; el('editUserCidade').value = ""; };
        window.salvarEdicaoUsuario = async () => { if(!idUsuarioEditando) return; const nome = el('editUserName').value.trim(); const senha = el('editUserPass').value.trim(); const cidadeId = el('editUserCidade').value; if(!nome || !senha) return alert("Nome e Senha s√£o obrigat√≥rios."); if(!cidadeId) return alert("Selecione uma Cidade para este usu√°rio."); await updateDoc(doc(db, "users", idUsuarioEditando), { nome, senha, cidadeId }); alert("Usu√°rio atualizado!"); cancelarEdicaoUsuario(); };
        window.excluirUsuario = async (id, nome) => { if(confirm(`Tem certeza que deseja excluir o usu√°rio ${nome}?`)) await deleteDoc(doc(db, "users", id)); };
        async function carregarConfigGeral() { try { const docSnap = await getDoc(doc(db, "config", "geral")); if(docSnap.exists()) { const d = docSnap.data(); if(el('confNomeCidade')) el('confNomeCidade').value = d.titulo || ""; if(el('opacAzul')) el('opacAzul').value = d.opacAzul || 80; if(el('opacPreto')) el('opacPreto').value = d.opacPreto || 50; if(el('confLogoHeight')) el('confLogoHeight').value = d.logoHeight || ""; if(el('confLogoTop')) el('confLogoTop').value = d.logoTop || ""; } } catch(e) { console.log("Config n√£o carregada (pode ser User):", e); } }
        window.salvarConfigGlobal = async () => { await setDoc(doc(db, "config", "geral"), { titulo: el('confNomeCidade').value, opacAzul: el('opacAzul').value, opacPreto: el('opacPreto').value, logoHeight: el('confLogoHeight').value, logoTop: el('confLogoTop').value }, { merge: true }); alert("Salvo!"); };
        el('checkDelivery').onchange = e => { el('boxDelivery').style.display = e.target.checked ? 'block':'none'; el('taxaEntrega').style.display = e.target.checked ? 'block':'none'; };
        el('checkPubli').onchange = e => el('boxPubli').style.display = e.target.checked ? 'block':'none';
        el('tipoValidade').onchange = e => { el('valorValidade').style.display = e.target.value === 'data' ? 'none':'block'; el('dataEspecifica').style.display = e.target.value === 'data' ? 'block':'none'; };
        window.removerPubli = () => { el('checkPubli').checked = false; el('imgPubli').value=""; el('boxPubli').style.display='none'; };
        function calcularDataFimPubli() { if(!el('checkPubli').checked) return null; const t=el('tipoValidade').value; const d=new Date(); if(t==='data'){ const dt=new Date(el('dataEspecifica').value); dt.setHours(23,59,59); return dt; } else { d.setDate(d.getDate() + (parseInt(el('valorValidade').value)||0)); return d; } }
        window.deletarLocalSeguro = async (id) => { const a=Math.floor(Math.random()*10), b=Math.floor(Math.random()*10); if(prompt(`${a}+${b}?`) == (a+b)) await deleteDoc(doc(db, "guia_cidades", id)); };
        window.zerarBanco = async () => { if(currentUser.role !== 'master') return; if(prompt("Tem certeza? Digite 'RESETAR'") === 'RESETAR') { const q = query(collection(db, "guia_cidades")); const snap = await getDocs(q); const batch = writeBatch(db); snap.forEach(doc => batch.delete(doc.ref)); await batch.commit(); alert("Dados apagados!"); }};
        function iniciarListenerLocais() { let q; if(currentUser.role === 'city') q = query(collection(db, "guia_cidades"), where("cidadeId", "==", currentUser.cityId)); else if(currentUser.role === 'owner') q = query(collection(db, "guia_cidades"), where("ownerId", "==", currentUser.userId)); else q = query(collection(db, "guia_cidades")); onSnapshot(q, (snap) => { const lista = el('lista-locais'); lista.innerHTML = ""; let itens = []; snap.forEach(d => itens.push({id: d.id, ...d.data()})); itens.sort((a,b) => (b.dataCadastro?.seconds || 0) - (a.dataCadastro?.seconds || 0)); if(itens.length === 0) lista.innerHTML = "<p style='text-align:center;color:#666'>Nada encontrado.</p>"; itens.forEach(item => { const div = document.createElement('div'); div.className = "item-lista"; div.innerHTML = `<div><strong>${item.nome}</strong><br><small>${item.categoria}</small></div><div><button class="btn-mini btn-warning">‚úèÔ∏è</button><button class="btn-mini btn-danger">‚úï</button></div>`; div.querySelector('.btn-warning').addEventListener('click', () => { window.carregarParaEdicao(item.id, item); }); div.querySelector('.btn-danger').addEventListener('click', () => { deletarLocalSeguro(item.id); }); lista.appendChild(div); }); }); }
    </script>
</body>
</html>