<!DOCTYPE html>
<html lang="pt-PT">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Guia da Cidade</title>
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#002244">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        /* ESTILOS GERAIS */
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', sans-serif; }
        body { background-color: #222; background-size: cover; background-position: center; background-attachment: fixed; min-height: 100vh; color: white; padding: 10px 0; display: flex; flex-direction: column; align-items: center; overflow-x: hidden; }
        
        #gradTop { position: fixed; top: 0; left: 0; width: 100%; height: 35%; pointer-events: none; z-index: 1; background: linear-gradient(to bottom, rgba(0, 60, 180, 0.85), transparent); }
        #gradBottom { position: fixed; bottom: 0; left: 0; width: 100%; height: 35%; pointer-events: none; z-index: 1; background: linear-gradient(to top, rgba(0, 0, 0, 0.9), transparent); }
        
        .sponsor-logo { position: fixed; bottom: 15px; left: 50%; transform: translateX(-50%); z-index: 5; pointer-events: none; display: none; height: 50px; width: auto; object-fit: contain; }
        
        #appContent { display: none; width: 100%; display: flex; flex-direction: column; align-items: center; position: relative; z-index: 10; }
        .header-container { width: 100%; max-width: 500px; text-align: center; margin-top: 20px; padding: 0 10px; position: relative; z-index: 20; }
        .header-top { display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 15px; }
        .header-logo { height: 50px; width: auto; cursor: pointer; transition: transform 0.2s; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); object-fit: contain; }
        
        .btn-hamburger { position: absolute; right: 0; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 28px; cursor: pointer; padding: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
        .btn-voltar-home { position: absolute; left: 0; top: 50%; transform: translateY(-50%); background: none; border: none; color: white; font-size: 24px; cursor: pointer; display: none; padding: 10px; }
        .main-menu-dropdown { position: absolute; top: 55px; right: 10px; background: white; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4); display: none; flex-direction: column; width: 180px; z-index: 1000; overflow: hidden; text-align: left; }
        .menu-opt { padding: 15px; color: #333; font-size: 14px; border-bottom: 1px solid #eee; cursor: pointer; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .menu-opt:hover { background: #f5f5f5; }
        
        .search-box { width: 100%; margin-bottom: 20px; position: relative; z-index: 10; display: flex; align-items: center; }
        .search-icon { position: absolute; left: 20px; color: #999; font-size: 18px; pointer-events: none; z-index: 11; }
        input { width: 100%; padding: 12px 20px; font-size: 16px; border-radius: 30px; border: none; outline: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3); text-align: center; background: rgba(255, 255, 255, 0.95); font-weight: 500; }
        
        #painelNavegacao { width: 90%; max-width: 500px; display: none; background: rgba(255, 255, 255, 0.95); border-radius: 15px; padding: 20px 20px 60px 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.5); color: #333; margin-bottom: 20px; position: relative; z-index: 10; }
        .cat-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
        .cat-card { display: flex; flex-direction: column; align-items: center; text-align: center; padding: 10px; border-radius: 10px; cursor: pointer; border: 1px solid #eee; }
        .cat-icon { font-size: 30px; margin-bottom: 5px; }
        .vip-card { background: linear-gradient(135deg, #6a11cb, #2575fc); color: white; border: none; box-shadow: 0 4px 10px rgba(106, 17, 203, 0.4); }
        .vip-card .cat-name { font-weight: bold; }
        
        #resultados { width: 90%; max-width: 500px; padding-bottom: 80px; display: none; position: relative; z-index: 10; }
        
        /* CARD ATUALIZADO */
        .card { 
            background: rgba(255, 255, 255, 0.95); 
            border-radius: 12px; 
            overflow: hidden; 
            margin-bottom: 15px; 
            color: #333; 
            display: flex; 
            align-items: flex-start; 
            padding: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); 
            min-height: 100px; 
            cursor: pointer; 
        }
        .card-img { width: 85px; height: 85px; object-fit: cover; border-radius: 8px; margin-right: 15px; background: #ddd; flex-shrink: 0; }
        .card-content { flex: 1; min-width: 0; display: flex; flex-direction: column; justify-content: center; }
        .card-content h3 { margin: 0 0 2px 0; font-size: 17px; color: #222; font-weight: 700; line-height: 1.2; }
        
        /* Descri√ß√£o (Aparece SOMENTE se existir) */
        .card-desc { 
            font-size: 12px; 
            color: #666; 
            margin-bottom: 4px; 
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Caminho de Categorias */
        .card-info { 
            font-size: 11px; 
            color: #888; 
            margin-bottom: 6px; 
            white-space: nowrap; 
            overflow: hidden; 
            text-overflow: ellipsis; 
        }
        
        .card-footer-row { display: flex; justify-content: space-between; align-items: center; margin-top: auto; }
        
        /* Badges */
        .tag { background: #e0e0e0; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; color: #555; display: inline-block; }
        .tag-delivery { background: #e8f5e9; color: #2e7d32; border: 1px solid #c8e6c9; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold; }
        .price-display { font-weight: bold; color: #333; font-size: 13px; }

        .vip-gift-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 15px; overflow: hidden; display: flex; padding: 15px; align-items: center; }
        .vip-gift-img { width: 110px; height: 110px; border-radius: 8px; object-fit: cover; background: #eee; margin-right: 15px; flex-shrink: 0; }
        .vip-gift-body { flex: 1; display: flex; flex-direction: column; justify-content: space-between; height: 110px; }
        .vip-gift-title { font-weight: bold; font-size: 18px; color: #333; margin: 0; line-height: 1.2; }
        .vip-gift-store { font-size: 13px; color: #666; margin-top: 5px; }
        .btn-concorrer { background: #28a745; color: white; border: none; padding: 10px; border-radius: 6px; font-weight: bold; width: 100%; cursor: pointer; font-size: 13px; margin-top: auto; transition: background 0.2s; }
        .btn-concorrer:active { transform: scale(0.95); background: #218838; }
        .btn-disabled { background: #6c757d !important; color: #fff !important; cursor: not-allowed !important; transform: none !important; opacity: 0.8; }

        .subcat-header { display: flex; align-items: center; margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .btn-voltar-cat { border: none; background: none; font-size: 20px; cursor: pointer; margin-right: 10px; }
        .subcat-chip { background: #f8f9fa; padding: 15px 10px; border-radius: 8px; font-size: 14px; color: #333; cursor: pointer; border: 1px solid #ddd; text-align: center; font-weight: 500; margin-bottom: 5px; display: block; }
        .city-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .city-modal-content { background: white; width: 85%; max-width: 400px; padding: 30px 20px; border-radius: 15px; text-align: center; }
        .btn-cad-user { width: 100%; padding: 12px; background: #28a745; color: white; border: none; border-radius: 8px; font-weight: bold; font-size: 16px; cursor: pointer; }
        .btn-want-vip { background: #25d366; margin-top: 10px; }
        .form-user input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; }
    </style>
</head>
<body>
    <div id="gradTop"></div><div id="gradBottom"></div><img id="logoPatra" class="sponsor-logo" src="">
    
    <div id="appContent">
        <div class="header-container">
            <div class="header-top">
                <button id="btnVoltarInicio" class="btn-voltar-home" onclick="clickVoltar()">‚¨Ö</button>
                <img src="logo.png" class="header-logo" alt="Guia" onclick="resetarApp()">
                <button class="btn-hamburger" onclick="toggleMenu()">‚ò∞</button>
                <div id="mainMenu" class="main-menu-dropdown">
                    <div class="menu-opt" onclick="abrirModalVipAccess()">üíé √Årea VIP</div>
                    <div class="menu-opt" onclick="abrirModalCadastroUser()">üë§ Cadastro</div>
                    <div class="menu-opt" onclick="abrirModalCidades(true)">üìç Trocar Cidade</div>
                    <div class="menu-opt" onclick="window.location.href='admin.html'">‚öôÔ∏è Admin</div>
                </div>
            </div>
            <div class="search-box"><span class="search-icon">üîç</span><input type="text" id="busca" placeholder="Carregando..." autocomplete="off"></div>
        </div>

        <div id="painelNavegacao">
            <div id="viewCategorias"><h3 style="margin-bottom:10px; font-size:16px;">Categorias</h3><div id="gridCategorias" class="cat-grid"></div></div>
            <div id="viewSubcategorias" style="display: none;"><div class="subcat-header"><button class="btn-voltar-cat" onclick="voltarParaCategorias()">‚¨Ö</button><h3 id="tituloCatSelecionada" style="margin:0; font-size:16px;">...</h3></div><div id="listaSubcats"></div></div>
        </div>
        <div id="resultados"></div>
    </div>

    <div id="modalVipAccess" class="city-modal" style="display:none" onclick="fecharModalVip(event)">
        <div class="city-modal-content form-user" onclick="event.stopPropagation()">
            <h2 style="margin-top:0; color:#ffc107;">üíé √Årea VIP</h2>
            <p style="color:#666; font-size:13px;">Digite a Palavra Secreta:</p>
            <input type="text" id="vipSecretInput" placeholder="Sua Senha" onkeypress="if(event.key==='Enter') validarVip()">
            <button class="btn-cad-user" style="background:#ffc107; color:black" onclick="validarVip()">Acessar</button>
            <button class="btn-cad-user btn-want-vip" onclick="solicitarVipZap()">Quero ser VIP</button>
            <button onclick="fecharModalVip()" style="margin-top:10px; background:none; border:none; color:#666; text-decoration:underline;">Cancelar</button>
        </div>
    </div>

    <div id="modalCidades" class="city-modal" style="display:none"><div class="city-modal-content"><h2 style="margin-top:0; color:#007bff;">Bem-vindo!</h2><p>Selecione sua cidade:</p><div id="listaCidadesSelect" style="max-height:300px;overflow-y:auto"></div></div></div>
    <div id="modalCadastroUser" class="city-modal" style="display:none" onclick="fecharModalCadastro(event)"><div class="city-modal-content form-user" onclick="event.stopPropagation()"><h2 style="margin-top:0; color:#28a745;">Cadastre seu Neg√≥cio</h2><select id="cadCidadeSelect"><option value="">Selecione sua Cidade</option></select><input id="cadNome" placeholder="Nome"><input id="cadEmail" placeholder="Email"><input id="cadSenha" type="password" placeholder="Senha"><button id="btnConfirmarCad" class="btn-cad-user" onclick="realizarCadastroUser()">Cadastrar</button><button onclick="fecharModalCadastro()" style="margin-top:10px;background:none;border:none;color:#666;text-decoration:underline">Cancelar</button></div></div>

    <script type="module">
        const VERSAO_ATUAL="5.1"; if(localStorage.getItem("v_app")!==VERSAO_ATUAL){localStorage.setItem("v_app",VERSAO_ATUAL);location.reload(true);}
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, getDocs, getDoc, doc, query, orderBy, where, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        const app=initializeApp({apiKey:"AIzaSyDsTWnP2cmsUIDeDlotoR1uELMAba_-dyw",authDomain:"testegithub-e1ffb.firebaseapp.com",projectId:"testegithub-e1ffb",storageBucket:"testegithub-e1ffb.firebasestorage.app",messagingSenderId:"508103458559",appId:"1:508103458559:web:55bc2fe4dc61d7b5ee16ca"}); const db=getFirestore(app);
        
        let viewState='home', lastCategory='', todosLocais=[], locaisFiltrados=[], estruturaCategorias=[], cidadeAtualId=localStorage.getItem("cidade_id"), customIcons={}, usuarioVipAtual=null;
        const ICONES_CAT = { "Comercio": "üõçÔ∏è", "Alimentacao": "üçî", "Servicos": "üõ†Ô∏è", "Saude": "üè•", "Publico": "üèõÔ∏è", "Profissionais": "üëî", "Delivery": "üõµ", "Classificados": "üì¢", "Aluguel": "üè†" };

        (function(){ emailjs.init("vOaHzeApkyntx09x6"); })();

        window.toggleMenu = () => { const m = document.getElementById('mainMenu'); m.style.display = (m.style.display === 'flex') ? 'none' : 'flex'; };
        document.addEventListener('click', e => { if(document.getElementById('mainMenu').style.display === 'flex' && !e.target.closest('.btn-hamburger') && !e.target.closest('.main-menu-dropdown')) { document.getElementById('mainMenu').style.display = 'none'; } });

        window.abrirModalVipAccess = () => { document.getElementById('modalVipAccess').style.display = 'flex'; window.toggleMenu(); };
        window.fecharModalVip = (e) => { if(!e || e.target.id === 'modalVipAccess') document.getElementById('modalVipAccess').style.display = 'none'; };
        
        window.validarVip = async () => {
            const word = document.getElementById('vipSecretInput').value.trim();
            if(!word) return alert("Digite a palavra secreta.");
            const q = query(collection(db, "vips"), where("palavra", "==", word)); const snap = await getDocs(q);
            if(!snap.empty) {
                usuarioVipAtual = snap.docs[0].data();
                alert(`Ol√° ${usuarioVipAtual.nome}!`);
                document.getElementById('modalVipAccess').style.display = 'none';
                abrirAreaVipExclusiva();
            } else { alert("Palavra incorreta."); }
        };

        async function abrirAreaVipExclusiva() {
            lastCategory="√Årea VIP"; document.getElementById('viewCategorias').style.display='none'; document.getElementById('viewSubcategorias').style.display='block'; document.getElementById('painelNavegacao').style.display='block'; document.getElementById('resultados').style.display='none'; document.getElementById('tituloCatSelecionada').textContent="üéÅ Sorteios da Semana"; document.getElementById('btnVoltarInicio').style.display='block'; viewState='subcats';
            const l = document.getElementById('listaSubcats'); l.innerHTML = "<p>Carregando sorteios...</p>";
            const qLocais = query(collection(db, "guia_cidades"), where("temDelivery", "==", true));
            const snapLocais = await getDocs(qLocais);
            const qPalpites = query(collection(db, "vip_palpites"), where("vipEmail", "==", usuarioVipAtual.email));
            const snapPalpites = await getDocs(qPalpites);
            const meusPalpites = {}; snapPalpites.forEach(p => { meusPalpites[p.data().localId] = p.data().numero; });

            l.innerHTML = "";
            if(snapLocais.empty) {
                l.innerHTML = "<p style='text-align:center;color:#666'>Nenhum sorteio esta semana.</p>";
            } else {
                snapLocais.forEach(d => {
                    const item = d.data();
                    let imgBrinde = "https://via.placeholder.com/300x300?text=Sem+Foto";
                    if(item.cardapio && Array.isArray(item.cardapio)) {
                        const itemCardapio = item.cardapio.find(x => x.nome === item.deliveryBrinde);
                        if(itemCardapio && itemCardapio.img) imgBrinde = itemCardapio.img;
                    }
                    const jaJogou = meusPalpites[d.id] !== undefined;
                    const numeroSorte = meusPalpites[d.id];
                    let btnHTML = `<button class="btn-concorrer" onclick="inscreverSorteio(this, '${d.id}', '${item.nome}', '${item.deliveryBrinde}')">QUERO ESSE</button>`;
                    if(jaJogou) { btnHTML = `<button class="btn-concorrer btn-disabled" disabled>Seu N¬∫: ${numeroSorte}</button>`; }

                    const card = document.createElement('div'); card.className = "vip-gift-card";
                    card.innerHTML = `<img src="${imgBrinde}" class="vip-gift-img"><div class="vip-gift-body"><div><div class="vip-gift-title">${item.deliveryBrinde}</div><span class="vip-gift-store">Oferecido por: <b>${item.nome}</b></span></div>${btnHTML}</div>`;
                    l.appendChild(card);
                });
            }
        }

        window.inscreverSorteio = async (btnElement, localId, lojaNome, brindeNome) => {
            if(!usuarioVipAtual) return alert("Erro de sess√£o.");
            if(confirm(`Gerar n√∫mero da sorte para: ${brindeNome}?`)) {
                const originalText = btnElement.innerText; btnElement.innerText = "...";
                try {
                    const numeroSorte = Math.floor(Math.random() * 10);
                    await addDoc(collection(db, "vip_palpites"), { vipNome: usuarioVipAtual.nome, vipEmail: usuarioVipAtual.email, vipZap: usuarioVipAtual.whatsapp || "", localId: localId, loja: lojaNome, brinde: brindeNome, numero: numeroSorte, cidadeId: cidadeAtualId, data: new Date() });
                    btnElement.innerText = `Seu N¬∫: ${numeroSorte}`; btnElement.classList.add('btn-disabled'); btnElement.disabled = true;
                    alert(`üéâ Seu n√∫mero da sorte √©: ${numeroSorte}!\n\nBoa sorte!`);
                } catch(e) { console.error(e); btnElement.innerText = originalText; alert("Erro. Tente novamente."); }
            }
        };

        window.solicitarVipZap = async () => { try { const g=await getDoc(doc(db,"config","geral")); if(g.exists()&&g.data().zapAdmin) window.open(`https://wa.me/${g.data().zapAdmin}?text=Quero ser VIP!`, '_blank'); else alert("Sem contato configurado."); } catch(e){} };
        window.clickVoltar = () => { if(viewState!=='home') { if(viewState==='subcats') voltarParaCategorias(); else resetarApp(); } };
        window.voltarParaCategorias = () => { document.getElementById('viewSubcategorias').style.display='none'; document.getElementById('viewCategorias').style.display='block'; document.getElementById('btnVoltarInicio').style.display='block'; viewState='cats'; };
        window.resetarApp = () => { document.getElementById('busca').value=""; document.getElementById('resultados').style.display='none'; document.getElementById('painelNavegacao').style.display='none'; document.getElementById('btnVoltarInicio').style.display='none'; document.getElementById('viewSubcategorias').style.display='none'; document.getElementById('viewCategorias').style.display='block'; viewState='home'; };

        const b = document.getElementById('busca');
        b.addEventListener('click', () => { if(b.value===""){ document.getElementById('painelNavegacao').style.display='block'; document.getElementById('resultados').style.display='none'; document.getElementById('btnVoltarInicio').style.display='block'; if(viewState!=='subcats') voltarParaCategorias(); } });
        b.addEventListener('keyup', (e) => { if(e.target.value.length>0) { document.getElementById('painelNavegacao').style.display='none'; document.getElementById('resultados').style.display='block'; document.getElementById('btnVoltarInicio').style.display='block'; viewState='results_search'; executarBusca(e.target.value.toLowerCase()); } else { document.getElementById('resultados').style.display='none'; document.getElementById('painelNavegacao').style.display='block'; viewState='cats'; }});

        async function carregarDadosIniciais() {
            await carregarCidades();
            try {
                const g = await getDoc(doc(db,"config","geral")); if(g.exists()){ const d=g.data(); 
                if(d.opacAzul!==undefined) document.getElementById('gradTop').style.background = `linear-gradient(to bottom, rgba(0, 60, 180, ${d.opacAzul/100}), transparent)`;
                if(d.opacPreto!==undefined) document.getElementById('gradBottom').style.background = `linear-gradient(to top, rgba(0,0,0, ${d.opacPreto/100}), transparent)`;
                const header = document.querySelector('.header-logo');
                if(d.headerSize) { header.style.height=d.headerSize+'px'; header.style.width='auto'; }
                if(d.headerTop) header.style.marginTop=d.headerTop+'px';
                const sponsor = document.getElementById('logoPatra');
                if(d.sponsorSize) { sponsor.style.height=d.sponsorSize+'px'; sponsor.style.width='auto'; sponsor.style.maxWidth='none'; sponsor.style.display='block'; }
                if(d.sponsorBottom) sponsor.style.bottom=d.sponsorBottom+'px';
                }
                const c = await getDoc(doc(db,"config","categorias")); if(c.exists()) estruturaCategorias=c.data();
                const i = await getDoc(doc(db,"config","icons")); if(i.exists()) customIcons=i.data();
                renderizarCategorias();
            } catch(e){}
            if(cidadeAtualId) carregarDadosLocais();
            document.getElementById('appContent').style.display = 'flex';
        }

        async function carregarCidades() {
            const snap = await getDocs(collection(db,"cidades")); const l=document.getElementById('listaCidadesSelect'); l.innerHTML="";
            snap.forEach(d => { const c=d.data(); l.innerHTML+=`<div class="city-item" onclick="selecionarCidade('${d.id}','${c.nome}','${c.uf}','${c.fundo}','${c.logoPatra}','${c.logoSize}','${c.logoBottom}')">${c.nome} - ${c.uf}</div>`; });
            const saved = snap.docs.find(d=>d.id===cidadeAtualId); if(saved) aplicarCidade(saved.data()); else document.getElementById('modalCidades').style.display='flex';
        }
        window.selecionarCidade = (id,n,u,f,l,ls,lb) => { cidadeAtualId=id; localStorage.setItem("cidade_id",id); aplicarCidade({nome:n,uf:u,fundo:f,logoPatra:l,logoSize:ls,logoBottom:lb}); document.getElementById('modalCidades').style.display='none'; carregarDadosLocais(); resetarApp(); };
        function aplicarCidade(c) {
            document.getElementById('busca').placeholder=`${c.nome} - ${c.uf}`;
            if(c.fundo) document.body.style.backgroundImage=`url('${c.fundo}')`;
            const lp=document.getElementById('logoPatra'); if(c.logoPatra){ lp.src=c.logoPatra; lp.style.display='block'; } else lp.style.display='none';
        }

        function renderizarCategorias() {
            const g=document.getElementById('gridCategorias'); g.innerHTML="";
            const ord = estruturaCategorias["_order"] || Object.keys(estruturaCategorias).filter(k=>k!=="_order").sort();
            ord.forEach(c => { 
                if(c === "√Årea VIP" || c === "Area Vip") return;
                const d=document.createElement('div'); d.className='cat-card'; 
                d.innerHTML=`<div class="cat-icon">${customIcons[c]||ICONES_CAT[c]||"üìÇ"}</div><div class="cat-name">${c}</div>`; 
                d.onclick=()=>abrirSubcategorias(c); g.appendChild(d); 
            });
            const vipCard = document.createElement('div'); vipCard.className='cat-card vip-card'; 
            vipCard.innerHTML=`<div class="cat-icon">üíé</div><div class="cat-name">√Årea VIP</div>`;
            vipCard.onclick = () => abrirModalVipAccess(); 
            g.appendChild(vipCard);
        }

        window.abrirSubcategorias = (c) => {
            lastCategory=c; document.getElementById('viewCategorias').style.display='none'; document.getElementById('viewSubcategorias').style.display='block'; document.getElementById('painelNavegacao').style.display='block'; document.getElementById('resultados').style.display='none'; document.getElementById('tituloCatSelecionada').textContent=c; document.getElementById('btnVoltarInicio').style.display='block'; viewState='subcats';
            const l=document.getElementById('listaSubcats'); l.innerHTML=""; 
            let subs = estruturaCategorias[c] || [];
            const chipTudo = document.createElement('div'); chipTudo.className='subcat-chip'; chipTudo.textContent=`Ver tudo de ${c}`; chipTudo.onclick=()=>{ pesquisarPorSubcategoria(c); }; l.appendChild(chipTudo);
            subs.forEach(s=>{ const d=document.createElement('div'); d.className='subcat-chip'; d.textContent=s; d.onclick=()=>{pesquisarPorSubcategoria(s)}; l.appendChild(d); });
        }
        
        window.pesquisarPorSubcategoria = (t) => {
            document.getElementById('busca').value = t; document.getElementById('painelNavegacao').style.display = 'none'; document.getElementById('resultados').style.display = 'block'; viewState = 'results_sub'; executarBusca(t.toLowerCase());
        };

        async function carregarDadosLocais() { const q=query(collection(db,"guia_cidades"),orderBy("nome")); const s=await getDocs(q); todosLocais=[]; s.forEach(d=>todosLocais.push({id:d.id,...d.data()})); aplicarFiltro(); }
        function aplicarFiltro() { if(cidadeAtualId) locaisFiltrados=todosLocais.filter(x=>x.cidadeId===cidadeAtualId); }
        function executarBusca(t) {
            const r=document.getElementById('resultados'); r.innerHTML="";
            const f=locaisFiltrados.filter(l=>(l.nomeBusca||l.nome).toLowerCase().includes(t)||(l.categoria||"").toLowerCase().includes(t)||(l.subcategoria||"").toLowerCase().includes(t));
            if(f.length===0) r.innerHTML="<p style='color:white;text-align:center'>Nada encontrado.</p>";
            f.forEach(i=>{ 
                const img=(i.imagens&&i.imagens[0])||i.imagem||"https://via.placeholder.com/150"; 
                let p=i.preco?`<div class="price-display">R$ ${i.preco.toLocaleString('pt-BR',{minimumFractionDigits:2})}</div>`:'';
                
                // CAMINHO COMPLETO DE INFO
                let infoPath = i.categoria || "";
                if(i.subcategoria) infoPath += " > " + i.subcategoria;
                if(i.setor) infoPath += " > " + i.setor;

                // DESCRI√á√ÉO (SE EXISTIR) OU NADA (VAZIO)
                // AQUI FOI A MUDAN√áA: REMOVIDA A OP√á√ÉO DE MOSTRAR CIDADE
                let descHtml = i.descricao ? `<p class="card-desc">${i.descricao}</p>` : '';

                // SELO DE DELIVERY
                let badgeDelivery = i.temDelivery ? `<span class="tag tag-delivery">üõµ Delivery</span>` : '';

                r.innerHTML+=`
                <div class="card" onclick="window.location.href='detalhes.html?id=${i.id}'">
                    <img src="${img}" class="card-img">
                    <div class="card-content">
                        <h3>${i.nome}</h3>
                        ${descHtml}
                        <p class="card-info">${infoPath}</p>
                        <div class="card-footer-row">
                            ${badgeDelivery}
                            ${p}
                        </div>
                    </div>
                </div>`; 
            });
        }
        carregarDadosIniciais();
        
        window.abrirModalCadastroUser=()=>{document.getElementById('modalCadastroUser').style.display='flex';window.toggleMenu&&window.toggleMenu();};
        window.abrirModalCidades=(c)=>{document.getElementById('modalCidades').style.display='flex';document.getElementById('btnCancelarCidade').style.display=c?'inline-block':'none';window.toggleMenu&&window.toggleMenu();};
        window.fecharModalCidades=()=>{document.getElementById('modalCidades').style.display='none';};
        window.fecharModalCadastro=(e)=>{if(!e||e.target.id==='modalCadastroUser')document.getElementById('modalCadastroUser').style.display='none';};
        window.realizarCadastroUser=async()=>{ const cid=document.getElementById('cadCidadeSelect').value; const nom=document.getElementById('cadNome').value.trim(); const ema=document.getElementById('cadEmail').value.trim(); const sen=document.getElementById('cadSenha').value.trim(); if(!cid||!nom||!ema||!sen) return alert("Preencha tudo"); try { await addDoc(collection(db,"users"),{nome:nom,email:ema,senha:sen,role:'owner',cidadeId:cid,dataCadastro:new Date()}); await emailjs.send('service_cuesjea','template_dftiawx',{to_name:nom,to_email:ema,user_login:ema,user_password:sen}); alert("Cadastro feito!"); window.location.href="admin.html"; } catch(e){console.error(e);alert("Erro ao cadastrar.");} };
    </script>
</body>
</html>